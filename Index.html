<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Anatomy Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #simulation-container {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            cursor: pointer;
            min-height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #simulation-container.has-zones {
            cursor: default;
        }
        .view-change-start {
            opacity: 0;
            transform: scale(0.95) rotate(-3deg);
        }
        .microscope-image {
            transition: filter 0.8s ease-in-out, transform 1.2s ease-in-out;
            max-width: 100%;
            max-height: 100%;
            display: block;
            transform-origin: center center;
        }
        #main-image {
            position: relative; /* In document flow, gives container height */
        }
        #next-image {
            /* Next image positioned absolutely for crossfade, overlays main-image */
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto; /* Centers the image */
        }
        .microscope-image.adjusting-focus {
            transition: filter 0.15s ease-out, transform 0.15s ease-out;
        }
        .blur-in {
            filter: blur(8px);
        }

        /* Microscope zoom animations */
        .zoom-in {
            transform: scale(1.5);
            filter: blur(15px);
        }
        .zoom-out-blurry {
            transform: scale(1.5);
            filter: blur(12px);
            opacity: 0.7;
        }
        .focus-sharpen {
            filter: blur(0px);
            opacity: 1;
            transition: filter 1.5s ease-out, opacity 0.8s ease-out;
        }

        /* Crossfade transition styles */
        .crossfade-out {
            opacity: 0;
            filter: blur(15px);
            transition: opacity 0.8s ease-in-out, filter 0.8s ease-in-out;
            pointer-events: none;
        }
        .crossfade-in {
            opacity: 1;
            transition: opacity 0.8s ease-in-out;
        }

        /* Zones overlay positioning - positioned absolutely to overlay the main-image */
        #zones-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }

        /* Clickable zone styles */
        .clickable-zone {
            position: absolute;
            cursor: pointer;
            pointer-events: auto;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: 2px solid transparent;
            z-index: 10;
        }
        .clickable-zone:hover {
            background-color: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            transform: scale(1.05);
        }
        .zone-label {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 20;
        }
        .clickable-zone:hover .zone-label {
            opacity: 1;
            transform: translateX(-50%) translateY(-12px);
        }

        /* Drawing mode buttons */
        .draw-mode-btn.active {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
            cursor: default;
        }
        .draw-mode-btn:not(.active) {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #4b5563; /* text-gray-600 */
        }
        .dark .draw-mode-btn:not(.active) {
            background-color: #4b5563; /* dark:bg-gray-600 */
            color: #d1d5db; /* dark:text-gray-300 */
        }

        /* Focus slider */
        #focus-slider-container {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        #focus-slider-container.visible {
            display: flex;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        #focus-slider-label {
            font-size: 14px;
            font-weight: 700;
            color: white;
            background: rgba(0, 0, 0, 0.75);
            padding: 8px 16px;
            border-radius: 8px;
            text-align: center;
            white-space: nowrap;
        }

        #focus-slider {
            -webkit-appearance: slider-vertical;
            width: 8px;
            height: 300px;
            background: linear-gradient(to top,
                #ef4444 0%,
                #f59e0b 25%,
                #10b981 45%,
                #10b981 55%,
                #f59e0b 75%,
                #ef4444 100%);
            border-radius: 8px;
            outline: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        #focus-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            border: 3px solid #667eea;
            transition: transform 0.1s ease;
        }

        #focus-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        #focus-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            border: 3px solid #667eea;
            transition: transform 0.1s ease;
        }

        #focus-slider::-moz-range-thumb:hover {
            transform: scale(1.2);
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .lesson-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            text-align: center;
        }
        .lesson-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        /* Skeleton Loader */
        .skeleton {
            background-color: #e2e8f0; /* bg-gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .dark .skeleton {
            background-color: #374151; /* dark:bg-gray-700 */
        }
        @keyframes pulse {
            50% {
                opacity: .5;
            }
        }

        /* Button Loader Spinner */
        .btn-spinner {
            display: inline-block;
            width: 1.25rem; /* w-5 */
            height: 1.25rem; /* h-5 */
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 0.5rem; /* mr-2 */
        }

        /* Zone Banner Styles */
        #zone-banner {
            position: fixed;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            opacity: 0;
            transform: translateY(-100%);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        #zone-banner.top {
            top: 0;
            transform: translateY(-100%);
        }
        #zone-banner.bottom {
            bottom: 0;
            transform: translateY(100%);
        }
        #zone-banner.visible {
            opacity: 1;
            transform: translateY(0);
        }
        #zone-banner-text {
            flex: 1;
            font-size: 16px;
            line-height: 1.5;
        }
        #zone-banner-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 20px;
            font-weight: bold;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
            flex-shrink: 0;
        }
        #zone-banner-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center min-h-screen p-4">

    <!-- Zone Banner (Hidden by default) -->
    <div id="zone-banner" class="bottom">
        <div id="zone-banner-text"></div>
        <button id="zone-banner-close" aria-label="Close banner">&times;</button>
    </div>

    <div class="w-full max-w-5xl bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 lg:p-10">

        <!-- View 1: Landing Page -->
        <div id="landing-page">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-blue-600 dark:text-blue-400">Interactive Anatomy Lab</h1>
                <p class="text-md text-gray-600 dark:text-gray-400 mt-2">Please select a lesson to begin.</p>
            </header>
            <div class="flex justify-center mb-4">
                <button id="lesson-setup-button" class="px-6 py-3 bg-gray-700 dark:bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-800 dark:hover:bg-gray-700 transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                    </svg>
                    Lesson Setup
                </button>
            </div>
            <div id="loader-container" class="flex justify-center items-center p-8">
                <div class="loader"></div>
            </div>
            <div id="lesson-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Lesson cards will be injected here by JavaScript -->
            </div>
        </div>

        <!-- View 2: Coordinate Helper (Initially Hidden) -->
        <div id="coordinate-helper-view" class="hidden">

            <!-- Coordinate Helper Sub-View 1: Lesson Selection -->
            <div id="coord-lesson-selection">
                <header class="text-center mb-6">
                    <h1 class="text-3xl md:text-4xl font-bold text-blue-600 dark:text-blue-400">üìç Coordinate Helper Tool</h1>
                    <p class="text-md text-gray-600 dark:text-gray-400 mt-2">Select a lesson to add clickable zones</p>
                </header>
                <div id="coord-loader-container" class="flex justify-center items-center p-8">
                    <div class="loader"></div>
                </div>
                <div id="coord-lesson-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Lesson cards will be injected here by JavaScript -->
                </div>
            </div>

            <!-- Coordinate Helper Sub-View 2: Image Selection -->
            <div id="coord-image-selection" class="hidden">
                <header class="text-center mb-4">
                    <h1 id="coord-lesson-title" class="text-2xl md:text-3xl font-bold text-blue-600 dark:text-blue-400"></h1>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Select an image to define zones</p>
                </header>
                <div id="coord-images-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Image cards will be injected here by JavaScript -->
                </div>
                <button id="coord-back-to-lessons" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-all">
                    ‚Üê Back to Lessons
                </button>
            </div>

            <!-- Coordinate Helper Sub-View 3: Canvas Editor -->
            <div id="coord-canvas-editor" class="hidden">
                <header class="text-center mb-4">
                    <h1 id="coord-canvas-title" class="text-2xl md:text-3xl font-bold text-blue-600 dark:text-blue-400">Zone Editor</h1>
                    <p id="coord-canvas-subtitle" class="text-sm text-gray-600 dark:text-gray-400 mt-1"></p>
                </header>

                <div class="mb-4">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                        <strong>Instructions:</strong><br>
                        - <strong>Rectangle Mode:</strong> Click and drag to create a rectangle.<br>
                        - <strong>Polygon Mode:</strong> Click to place points. Click the first point to close the shape.
                    </p>
                </div>

                <div class="flex items-center justify-center gap-2 mb-4">
                    <button id="draw-mode-rect" class="px-4 py-2 text-sm font-semibold rounded-lg transition-all">Rectangle</button>
                    <button id="draw-mode-poly" class="px-4 py-2 text-sm font-semibold rounded-lg transition-all">Polygon</button>
                </div>
                <div class="relative w-full max-w-3xl mx-auto bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden border-2 border-gray-300 dark:border-gray-600" id="canvas-wrapper">
                    <div id="canvas-loader" class="absolute inset-0 bg-gray-200/50 dark:bg-gray-800/50 flex items-center justify-center hidden z-10"><div class="loader"></div></div>
                    <canvas id="coord-canvas" class="w-full cursor-crosshair"></canvas>
                </div>

                <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Zone List -->
                    <div>
                        <h3 class="font-bold text-lg mb-2">Defined Zones:</h3>
                        <div id="zones-list" class="space-y-2 max-h-64 overflow-y-auto">
                            <p class="text-sm text-gray-500 dark:text-gray-400">No zones defined yet. Click and drag on the image to create zones.</p>
                        </div>
                    </div>

                    <!-- JSON Output -->
                    <div>
                        <h3 class="font-bold text-lg mb-2">JSON Output:</h3>

                        <!-- Context Info -->
                        <div id="coord-context-info" class="mb-3 p-2 bg-blue-50 dark:bg-blue-900 rounded text-xs">
                            <strong>Lesson:</strong> <span id="json-lesson-name"></span><br>
                            <strong>Image:</strong> <span id="json-image-index"></span> - <span id="json-image-desc"></span>
                        </div>

                        <!-- Zones Array (For Spreadsheet) -->
                        <div class="mb-3">
                            <div class="flex items-center justify-between mb-1">
                                <label class="text-sm font-bold text-green-700 dark:text-green-400">‚úÖ Zones Array (Paste into Spreadsheet)</label>
                                <button id="copy-zones-array" class="px-3 py-1 bg-green-600 text-white text-xs font-semibold rounded hover:bg-green-700 transition-all">
                                    üìã Copy
                                </button>
                            </div>
                            <textarea id="json-zones-array" readonly
                                      class="w-full h-24 px-3 py-2 border-2 border-green-500 dark:border-green-600 rounded-lg bg-white dark:bg-gray-700 font-mono text-xs resize-none"
                                      placeholder="[]"></textarea>
                            <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                ‚¨ÜÔ∏è Copy this and paste into the <strong>Zones column</strong> of your spreadsheet
                            </p>
                        </div>

                        <!-- Full Metadata (Reference) -->
                        <div class="mb-3">
                            <div class="flex items-center justify-between mb-1">
                                <label class="text-sm font-semibold text-gray-600 dark:text-gray-400">üìÑ Full Metadata (Reference Only)</label>
                                <button id="copy-full-metadata" class="px-3 py-1 bg-gray-500 text-white text-xs font-semibold rounded hover:bg-gray-600 transition-all">
                                    üìã Copy
                                </button>
                            </div>
                            <textarea id="json-full-metadata" readonly
                                      class="w-full h-24 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 font-mono text-xs resize-none"
                                      placeholder="{}"></textarea>
                        </div>

                        <!-- Action Buttons -->
                        <button id="clear-zones" class="mt-2 px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-all">
                            üóëÔ∏è Clear All Zones
                        </button>
                    </div>
                </div>

                <div class="mt-4 flex gap-2">
                    <button id="coord-back-to-images" class="px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-all">
                        ‚Üê Back to Images
                    </button>
                    <button id="coord-back-to-lessons-from-canvas" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-all">
                        ‚Üê Back to Lessons
                    </button>
                </div>
            </div>

        </div>

        <!-- View 3: Simulation View (Initially Hidden) -->
        <div id="simulation-view" class="hidden">
            <header class="text-center mb-6 px-4 md:px-6 lg:px-8">
                 <h1 id="lesson-title" class="text-2xl md:text-3xl font-bold text-blue-600 dark:text-blue-400"></h1>
                 <p id="instruction-text" class="text-md text-gray-600 dark:text-gray-400 mt-1 min-h-[24px]"></p>
            </header>
            <div id="simulation-loader" class="flex justify-center items-center p-8 hidden">
                <div class="loader"></div>
            </div>
            <div class="flex items-center justify-center gap-6 w-full max-w-5xl mx-auto">
                <div id="simulation-container" class="relative w-full max-w-3xl rounded-lg overflow-hidden shadow-inner border border-gray-200 dark:border-gray-700">
                    <img id="main-image" src="" alt="Anatomy diagram" class="microscope-image">
                    <img id="next-image" src="" alt="Next anatomy diagram" class="microscope-image" style="opacity: 0; pointer-events: none;">
                    <div id="zones-overlay"></div>
                </div>
                <div id="focus-slider-container">
                    <div id="focus-slider-label">üî¨ Adjust Focus</div>
                    <input type="range" id="focus-slider" min="0" max="100" value="50" orient="vertical">
                </div>
            </div>
            <div class="mt-4 flex justify-between items-center">
                 <button id="back-to-lessons-button" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all">
                    Back to Lessons
                </button>
                <button id="back-button" class="px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all hidden">
                    Previous Image
                </button>
            </div>
        </div>

        <!-- View 4: Admin Lesson Management (Initially Hidden) -->
        <div id="admin-view" class="hidden">

            <!-- Admin Sub-View 1: Lesson List -->
            <div id="admin-lesson-list">
                <header class="text-center mb-6">
                    <h1 class="text-3xl md:text-4xl font-bold text-blue-600 dark:text-blue-400">Lesson Management</h1>
                    <p class="text-md text-gray-600 dark:text-gray-400 mt-2">Create and edit lessons</p>
                </header>
                <div class="flex justify-between mb-4">
                    <button id="admin-create-lesson-btn" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-all">
                        + Create New Lesson
                    </button>
                    <button id="admin-back-to-main" class="px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-all">
                        ‚Üê Back to Main
                    </button>
                </div>
                <div id="admin-loader-container" class="flex justify-center items-center p-8 hidden">
                    <div class="loader"></div>
                </div>
                <div id="admin-lesson-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Lesson cards will be injected here -->
                </div>
            </div>

            <!-- Admin Sub-View 2: Create/Edit Lesson -->
            <div id="admin-lesson-form" class="hidden">
                <header class="text-center mb-6">
                    <h1 id="admin-form-title" class="text-2xl md:text-3xl font-bold text-blue-600 dark:text-blue-400">Create New Lesson</h1>
                </header>
                <div class="max-w-2xl mx-auto">
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2">Lesson Title</label>
                        <input type="text" id="lesson-title-input" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter lesson title">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2">Lesson Description</label>
                        <textarea id="lesson-description-input" rows="3" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter lesson description"></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button id="admin-save-lesson-btn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-all">
                            Save & Continue to Images
                        </button>
                        <button id="admin-cancel-lesson-btn" class="px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-all">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Admin Sub-View 3: Image Upload & Management -->
            <div id="admin-image-manager" class="hidden">
                <header class="text-center mb-4">
                    <h1 id="admin-image-manager-title" class="text-2xl md:text-3xl font-bold text-blue-600 dark:text-blue-400">Manage Images</h1>
                    <p id="admin-image-manager-subtitle" class="text-sm text-gray-600 dark:text-gray-400 mt-1"></p>
                </header>

                <div class="mb-6">
                    <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center bg-gray-50 dark:bg-gray-700">
                        <input type="file" id="image-file-input" accept="image/*" multiple class="hidden">
                        <button id="upload-image-btn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-all">
                            üìÅ Upload Image from Computer
                        </button>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-4">or paste an image (Ctrl+V / Cmd+V)</p>
                        <div id="paste-area" class="mt-4 p-4 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 min-h-[100px] focus:outline-none focus:ring-2 focus:ring-blue-500" tabindex="0">
                            Click here and paste an image
                        </div>
                    </div>
                </div>

                <div id="image-preview-section" class="hidden">
                    <h3 class="font-bold text-lg mb-2">Image Preview:</h3>
                    <img id="image-preview" class="max-w-full max-h-64 rounded-lg shadow-md mb-4" alt="Preview">
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2">Image Description</label>
                        <input type="text" id="image-description-input" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter image description">
                    </div>
                    <div class="flex gap-2">
                        <button id="save-and-define-zones-btn" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-all">
                            Save & Define Click Zones
                        </button>
                        <button id="clear-image-btn" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-all">
                            Clear
                        </button>
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="font-bold text-lg mb-2">Existing Images:</h3>
                    <div id="existing-images-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Existing images will be listed here -->
                    </div>
                </div>

                <div class="mt-4 flex gap-2">
                    <button id="admin-back-to-lesson-list" class="px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-all">
                        ‚Üê Back to Lesson List
                    </button>
                </div>
            </div>

            <!-- Admin Sub-View 4: Zone Editor (Integrated from Coordinate Helper) -->
            <div id="admin-zone-editor" class="hidden">
                <header class="text-center mb-4">
                    <h1 id="admin-zone-editor-title" class="text-2xl md:text-3xl font-bold text-blue-600 dark:text-blue-400">Define Click Zones</h1>
                    <p id="admin-zone-editor-subtitle" class="text-sm text-gray-600 dark:text-gray-400 mt-1"></p>
                </header>

                <div class="mb-4">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                        <strong>Instructions:</strong><br>
                        - <strong>Rectangle Mode:</strong> Click and drag to create a rectangle.<br>
                        - <strong>Polygon Mode:</strong> Click to place points. Click the first point to close the shape.
                    </p>
                </div>

                <div class="flex items-center justify-center gap-2 mb-4">
                    <button id="admin-draw-mode-rect" class="px-4 py-2 text-sm font-semibold rounded-lg transition-all">Rectangle</button>
                    <button id="admin-draw-mode-poly" class="px-4 py-2 text-sm font-semibold rounded-lg transition-all">Polygon</button>
                </div>

                <div class="relative w-full max-w-3xl mx-auto bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden border-2 border-gray-300 dark:border-gray-600" id="admin-canvas-wrapper">
                    <div id="admin-canvas-loader" class="absolute inset-0 bg-gray-200/50 dark:bg-gray-800/50 flex items-center justify-center hidden z-10"><div class="loader"></div></div>
                    <canvas id="admin-canvas" class="w-full cursor-crosshair"></canvas>
                </div>

                <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-bold text-lg mb-2">Defined Zones:</h3>
                        <div id="admin-zones-list" class="space-y-2 max-h-64 overflow-y-auto">
                            <p class="text-sm text-gray-500 dark:text-gray-400">No zones defined yet.</p>
                        </div>
                    </div>
                    <div>
                        <button id="admin-clear-zones" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-all">
                            üóëÔ∏è Clear All Zones
                        </button>
                    </div>
                </div>

                <div class="mt-4 flex gap-2">
                    <button id="admin-save-zones-btn" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-all">
                        üíæ Save Zones & Continue
                    </button>
                    <button id="admin-back-to-images" class="px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-all">
                        ‚Üê Back to Images
                    </button>
                </div>
            </div>

        </div>

        <!-- Admin Login Modal -->
        <div id="admin-login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold text-blue-600 dark:text-blue-400 mb-4">Admin Login</h2>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Enter your credentials to access lesson setup.</p>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2">Username</label>
                    <input type="text" id="admin-username" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2">Password</label>
                    <input type="password" id="admin-password" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="admin-login-error" class="hidden mb-4 p-3 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-200 rounded-lg text-sm">
                </div>
                <div class="flex gap-2">
                    <button id="admin-login-btn" class="flex-1 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-all flex items-center justify-center">
                        Login
                    </button>
                    <button id="admin-login-cancel" class="flex-1 px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-all">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Generic Modal for Confirm/Prompt -->
        <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all" id="modal-content">
                <h2 id="modal-title" class="text-2xl font-bold text-blue-600 dark:text-blue-400 mb-4">Confirmation</h2>
                <p id="modal-message" class="text-gray-600 dark:text-gray-400 mb-6">Are you sure?</p>
                <input type="text" id="modal-input" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 hidden mb-4">
                <div id="modal-multi-fields" class="hidden mb-4"></div>
                <div class="flex gap-4 justify-end">
                    <button id="modal-cancel-btn" class="px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-all">
                        Cancel
                    </button>
                    <button id="modal-confirm-btn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-all">
                        Confirm
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global variable for tool mode - will be initialized on page load
        var TOOL_MODE = '';

        // Safely parse tool mode from URL query parameter (e.g., ?tool=coordinates)
        try {
            if (window.location && window.location.search) {
                var urlParams = new URLSearchParams(window.location.search);
                TOOL_MODE = urlParams.get('tool') || '';
            }
        } catch (e) {
            console.error('Error parsing URL parameters:', e);
            TOOL_MODE = '';
        }

        // --- CUSTOM MODAL & NOTIFICATION LOGIC ---
        let modalResolve = null;

        /**
         * Shows a custom modal for confirmations or prompts. Returns a Promise.
         * @param {object} options - { title, message, type ('confirm'|'prompt'|'select'), placeholder, options }
         * @returns {Promise<boolean|string|null>}
         */
        function showCustomModal({ title, message, type = 'confirm', placeholder = '', options = [], defaultValue = '', fields = [] }) {
            return new Promise(resolve => {
                modalResolve = resolve;

                const modal = document.getElementById('custom-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalMessage = document.getElementById('modal-message');
                const modalInput = document.getElementById('modal-input');
                const modalConfirmBtn = document.getElementById('modal-confirm-btn');

                modalTitle.textContent = title;
                modalMessage.textContent = message;

                if (type === 'prompt') {
                    modalInput.classList.remove('hidden');
                    modalInput.value = defaultValue || '';
                    modalInput.placeholder = placeholder;
                    modalInput.type = 'text';
                    modalConfirmBtn.textContent = 'Submit';
                } else if (type === 'select') {
                    // Convert input to select element with defaultValue support
                    const selectHtml = `<select id="modal-select" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                        ${options.map(opt => `<option value="${opt.value}" ${opt.value === defaultValue ? 'selected' : ''}>${opt.label}</option>`).join('')}
                    </select>`;
                    modalInput.classList.add('hidden');
                    document.getElementById('modal-multi-fields').classList.add('hidden');

                    // Insert select before the buttons
                    const existingSelect = document.getElementById('modal-select');
                    if (existingSelect) {
                        existingSelect.remove();
                    }
                    modalInput.insertAdjacentHTML('afterend', selectHtml);
                    modalConfirmBtn.textContent = 'Submit';
                } else if (type === 'multi') {
                    // Multi-field form support
                    modalInput.classList.add('hidden');
                    const existingSelect = document.getElementById('modal-select');
                    if (existingSelect) {
                        existingSelect.remove();
                    }

                    const multiFieldsContainer = document.getElementById('modal-multi-fields');
                    multiFieldsContainer.classList.remove('hidden');

                    // Build form fields based on the fields array
                    // fields format: [{ type: 'text'|'select', id: 'field-id', label: 'Field Label', placeholder: '', value: '', options: [] }]
                    const fieldsHtml = fields.map(field => {
                        if (field.type === 'text') {
                            return `
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">${field.label}</label>
                                    <input type="text" id="modal-field-${field.id}" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="${field.placeholder || ''}" value="${field.value || ''}">
                                </div>
                            `;
                        } else if (field.type === 'select') {
                            return `
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">${field.label}</label>
                                    <select id="modal-field-${field.id}" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        ${field.options.map(opt => `<option value="${opt.value}" ${opt.value === field.value ? 'selected' : ''}>${opt.label}</option>`).join('')}
                                    </select>
                                </div>
                            `;
                        }
                        return '';
                    }).join('');

                    multiFieldsContainer.innerHTML = fieldsHtml;
                    modalConfirmBtn.textContent = 'Submit';
                } else {
                    modalInput.classList.add('hidden');
                    document.getElementById('modal-multi-fields').classList.add('hidden');
                    const existingSelect = document.getElementById('modal-select');
                    if (existingSelect) {
                        existingSelect.remove();
                    }
                    modalConfirmBtn.textContent = 'Confirm';
                }

                modal.classList.remove('hidden');
            });
        }

        function handleModalConfirm() {
            const modalInput = document.getElementById('modal-input');
            const modalSelect = document.getElementById('modal-select');
            const modalMultiFields = document.getElementById('modal-multi-fields');

            if (modalResolve) {
                if (!modalMultiFields.classList.contains('hidden')) {
                    // Multi-field form - gather all field values
                    const fieldValues = {};
                    const fieldElements = modalMultiFields.querySelectorAll('[id^="modal-field-"]');
                    fieldElements.forEach(el => {
                        const fieldId = el.id.replace('modal-field-', '');
                        fieldValues[fieldId] = el.value;
                    });
                    modalResolve(fieldValues);
                } else if (modalSelect) {
                    // Select type modal
                    modalResolve(modalSelect.value);
                } else if (!modalInput.classList.contains('hidden')) {
                    // Prompt type modal
                    modalResolve(modalInput.value);
                } else {
                    // Confirm type modal
                    modalResolve(true);
                }
            }
            closeModal();
        }

        function handleModalCancel() {
            if (modalResolve) {
                const modalInput = document.getElementById('modal-input');
                modalResolve(!modalInput.classList.contains('hidden') ? null : false);
            }
            closeModal();
        }

        function closeModal() {
            document.getElementById('custom-modal').classList.add('hidden');
            modalResolve = null;
        }

        /**
         * Generic failure handler for google.script.run calls. Displays a toast notification.
         * @param {Error} error The error object from the failed call.
         */
        function onScriptRunFailure(error) {
            console.error('Google Script run failed:', error);
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-5 right-5 bg-red-600 text-white py-3 px-6 rounded-lg shadow-lg z-50 transition-transform transform translate-y-20';
            toast.textContent = `Server Error: ${error.message}`;
            document.body.appendChild(toast);
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-y-20');
            }, 10);
            // Animate out and remove
            setTimeout(() => {
                toast.classList.add('translate-y-20');
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        }
        
        // --- LOADER/SPINNER UTILITY FUNCTIONS ---

        /**
         * Shows a loading state on a button.
         * @param {HTMLElement} button The button element to update.
         * @param {string} loadingText The text to display while loading.
         */
        function showButtonLoader(button, loadingText = 'Loading...') {
            if (!button) return;
            button.disabled = true;
            // Store original content if it doesn't exist
            if (!button.dataset.originalContent) {
                button.dataset.originalContent = button.innerHTML;
            }
            button.innerHTML = `<span class="btn-spinner"></span> ${loadingText}`;
        }

        /**
         * Hides the loading state on a button and restores its original content.
         * @param {HTMLElement} button The button element to restore.
         */
        function hideButtonLoader(button) {
            if (!button) return;
            button.disabled = false;
            if (button.dataset.originalContent) {
                button.innerHTML = button.dataset.originalContent;
            }
        }

        /**
         * Generates and displays skeleton cards.
         * @param {HTMLElement} container The container to fill with skeleton cards.
         * @param {number} count The number of skeleton cards to generate.
         * @param {string} type 'lesson' or 'image' to apply different height classes.
         */
        function showSkeletonLoader(container, count = 3, type = 'lesson') {
            if (!container) return;
            container.innerHTML = '';
            const heightClass = type === 'lesson' ? 'h-64' : 'h-72';
            for (let i = 0; i < count; i++) {
                const skeletonCard = document.createElement('div');
                skeletonCard.className = `skeleton ${heightClass}`;
                container.appendChild(skeletonCard);
            }
        }

        /**
         * Shows a loading state on a card element (lesson/image card).
         * @param {HTMLElement} card The card element to update.
         */
        function showCardLoader(card) {
            if (!card) return;
            // Store original state
            card.dataset.originalCursor = card.style.cursor || '';
            card.dataset.wasDisabled = card.style.pointerEvents || '';

            // Disable interactions and add visual feedback
            card.style.pointerEvents = 'none';
            card.style.opacity = '0.6';
            card.style.cursor = 'wait';

            // Add spinner overlay
            const spinner = document.createElement('div');
            spinner.className = 'absolute inset-0 flex items-center justify-center bg-white bg-opacity-50 dark:bg-gray-800 dark:bg-opacity-50 z-10';
            spinner.innerHTML = '<div class="loader"></div>';
            spinner.dataset.cardSpinner = 'true';
            card.style.position = 'relative';
            card.appendChild(spinner);
        }

        /**
         * Hides the loading state on a card element.
         * @param {HTMLElement} card The card element to restore.
         */
        function hideCardLoader(card) {
            if (!card) return;
            // Restore original state
            card.style.pointerEvents = card.dataset.wasDisabled || '';
            card.style.opacity = '1';
            card.style.cursor = card.dataset.originalCursor || '';

            // Remove spinner overlay
            const spinner = card.querySelector('[data-card-spinner="true"]');
            if (spinner) {
                spinner.remove();
            }
        }


        // --- MAIN APP LOGIC ---

        // DOM Element References
        const landingPage = document.getElementById('landing-page');
        const simulationView = document.getElementById('simulation-view');
        const loaderContainer = document.getElementById('loader-container');
        const simulationLoader = document.getElementById('simulation-loader');
        const lessonCardsContainer = document.getElementById('lesson-cards-container');
        const lessonTitle = document.getElementById('lesson-title');
        const instructionText = document.getElementById('instruction-text');
        const simulationContainer = document.getElementById('simulation-container');
        const mainImage = document.getElementById('main-image');
        const nextImage = document.getElementById('next-image');
        const backToLessonsButton = document.getElementById('back-to-lessons-button');
        const backButton = document.getElementById('back-button');
        const zonesOverlay = document.getElementById('zones-overlay');
        const focusSliderContainer = document.getElementById('focus-slider-container');
        const focusSlider = document.getElementById('focus-slider');

        let currentLessonViews = [];
        let currentViewIndex = -1;
        let viewHistory = []; // Stack to track navigation history for back button
        let awaitingFocusAdjustment = false;
        let optimalFocusValue = 50; // The "correct" slider position for sharp focus

        /**
         * Builds the lesson cards on the landing page.
         */
        function buildLandingPage(lessons) {
            loaderContainer.style.display = 'none';
            lessonCardsContainer.innerHTML = ''; // Clear previous cards

            if (!lessons || lessons.length === 0) {
                lessonCardsContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">No lessons found. Please add lessons in the 'Lesson Database' sheet.</p>`;
                return;
            }
            if (lessons[0].error) {
                lessonCardsContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">${lessons[0].error}</p>`;
                return;
            }

            lessons.forEach(lesson => {
                const card = document.createElement('div');
                card.className = 'lesson-card bg-gray-50 dark:bg-gray-700 rounded-lg shadow-md overflow-hidden cursor-pointer';
                card.innerHTML = `
                    <img src="${lesson.previewImage || 'https://placehold.co/600x400/eeeeee/333333?text=No+Image'}" alt="${lesson.name}" class="w-full h-40 object-cover" onerror="this.src='https://placehold.co/600x400/eeeeee/333333?text=Image+Error'">
                    <div class="p-6 text-center">
                        <h3 class="font-bold text-lg">${lesson.name}</h3>
                        <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">${lesson.description || 'No description available.'}</p>
                    </div>
                `;
                card.addEventListener('click', () => {
                    showCardLoader(card);
                    selectLesson(lesson.name);
                });
                lessonCardsContainer.appendChild(card);
            });
        }
        
        /**
         * Handles the selection of a lesson from a card.
         */
        function selectLesson(lessonName) {
            landingPage.style.display = 'none';
            simulationView.style.display = 'block';
            simulationLoader.style.display = 'flex';
            simulationContainer.style.display = 'none';
            lessonTitle.textContent = lessonName;
            
            google.script.run
                .withSuccessHandler(startLesson)
                .withFailureHandler(onScriptRunFailure)
                .getLessonData(lessonName);
        }

        /**
         * Kicks off the simulation for the selected lesson.
         */
        function startLesson(viewsData) {
            simulationLoader.style.display = 'none';
            simulationContainer.style.display = 'block';
            currentLessonViews = viewsData;
            viewHistory = []; // Clear navigation history for new lesson

            if (currentLessonViews.length === 0) {
                instructionText.textContent = "This lesson has no images to display.";
                simulationContainer.style.display = 'none';
                return;
            }
            renderView(0);
        }

        /**
         * Shows the zone banner with text at specified position.
         * @param {string} text The text to display in the banner
         * @param {string} position 'top' or 'bottom' (defaults to 'bottom')
         */
        function showZoneBanner(text, position = 'bottom') {
            const banner = document.getElementById('zone-banner');
            const bannerText = document.getElementById('zone-banner-text');

            // Set text
            bannerText.textContent = text;

            // Set position
            banner.classList.remove('top', 'bottom');
            banner.classList.add(position);

            // Show banner
            setTimeout(() => {
                banner.classList.add('visible');
            }, 50);
        }

        /**
         * Hides the zone banner.
         */
        function hideZoneBanner() {
            const banner = document.getElementById('zone-banner');
            banner.classList.remove('visible');
        }

        /**
         * Creates clickable zone overlays for the current view.
         * Uses pixel positioning directly based on image dimensions for accurate alignment.
         */
        function createZoneOverlays(zones) {
            zonesOverlay.innerHTML = ''; // Clear existing zones

            console.log('createZoneOverlays called with zones:', zones);

            if (!zones || zones.length === 0) {
                console.log('No zones to create');
                simulationContainer.classList.remove('has-zones');
                return;
            }

            simulationContainer.classList.add('has-zones');
            console.log(`Creating ${zones.length} zone overlays`);

            // Get the rendered dimensions of the image
            const imageRect = mainImage.getBoundingClientRect();
            const renderedWidth = imageRect.width;
            const renderedHeight = imageRect.height;

            console.log('Rendered image dimensions:', renderedWidth, 'x', renderedHeight);

            zones.forEach((zone, index) => {
                console.log(`Zone ${index}:`, zone);

                const zoneDiv = document.createElement('div');
                zoneDiv.className = 'clickable-zone';

                // Convert zone percentages directly to pixels based on rendered image size
                // Zone percentages are relative to the image natural dimensions
                const zoneLeftPx = (zone.x / 100) * renderedWidth;
                const zoneTopPx = (zone.y / 100) * renderedHeight;
                const zoneWidthPx = (zone.width / 100) * renderedWidth;
                const zoneHeightPx = (zone.height / 100) * renderedHeight;

                // Use pixel positioning directly
                zoneDiv.style.left = `${zoneLeftPx}px`;
                zoneDiv.style.top = `${zoneTopPx}px`;
                zoneDiv.style.width = `${zoneWidthPx}px`;
                zoneDiv.style.height = `${zoneHeightPx}px`;

                console.log(`Zone ${index} positioned at: left=${zoneLeftPx.toFixed(2)}px, top=${zoneTopPx.toFixed(2)}px, width=${zoneWidthPx.toFixed(2)}px, height=${zoneHeightPx.toFixed(2)}px`);

                // Add label tooltip
                const label = document.createElement('div');
                label.className = 'zone-label';
                label.textContent = zone.label || `Zone ${index + 1}`;
                zoneDiv.appendChild(label);

                // Add click handler for zone
                zoneDiv.addEventListener('click', (e) => {
                    console.log(`Zone ${index} clicked!`);
                    e.stopPropagation();

                    // Check if zone displays a banner
                    if (zone.actionType === 'banner' && zone.bannerText) {
                        const position = zone.bannerPosition || 'bottom';
                        showZoneBanner(zone.bannerText, position);
                    }
                    // Check if zone has a specific target view
                    else if (zone.targetView !== undefined && zone.targetView !== null) {
                        const targetIndex = parseInt(zone.targetView);
                        if (targetIndex >= 0 && targetIndex < currentLessonViews.length) {
                            navigateToView(targetIndex);
                        } else {
                            console.error(`Invalid targetView ${targetIndex} for zone ${index}`);
                            zoomToNextView(); // Fallback to sequential navigation
                        }
                    } else {
                        // Default behavior: advance to next view sequentially
                        zoomToNextView();
                    }
                });

                zonesOverlay.appendChild(zoneDiv);
            });
        }

        /**
         * Performs the microscope zoom animation sequence with smooth crossfade.
         */
        function zoomToNextView() {
            if (currentViewIndex + 1 >= currentLessonViews.length) return;

            // Add current view to history before navigating
            viewHistory.push(currentViewIndex);

            zonesOverlay.innerHTML = '';
            simulationContainer.classList.remove('has-zones');

            const nextView = currentLessonViews[currentViewIndex + 1];

            nextImage.classList.add('zoom-out-blurry');
            nextImage.style.opacity = '0';
            nextImage.src = nextView.imageUrl;

            nextImage.onload = () => {
                mainImage.classList.add('zoom-in');

                setTimeout(() => {
                    mainImage.classList.add('crossfade-out');
                    nextImage.classList.add('crossfade-in');
                    nextImage.style.opacity = '1';

                    setTimeout(() => {
                        currentViewIndex++;
                        instructionText.textContent = nextView.description;

                        mainImage.src = nextView.imageUrl;
                        mainImage.classList.remove('zoom-in', 'crossfade-out');
                        mainImage.classList.add('zoom-out-blurry');
                        mainImage.style.opacity = '1';

                        nextImage.style.opacity = '0';
                        nextImage.classList.remove('crossfade-in', 'zoom-out-blurry');

                        awaitingFocusAdjustment = true;

                        const randomStart = Math.random() > 0.5
                            ? Math.floor(Math.random() * 30) + 10  // 10-40 range
                            : Math.floor(Math.random() * 30) + 60; // 60-90 range
                        focusSlider.value = randomStart;

                        const initialBlur = calculateBlurAmount(randomStart);
                        const initialScale = calculateScale(randomStart);
                        mainImage.style.filter = `blur(${initialBlur}px)`;
                        mainImage.style.transform = `scale(${initialScale})`;

                        mainImage.classList.add('adjusting-focus');
                        focusSliderContainer.classList.add('visible');
                        backButton.classList.toggle('hidden', viewHistory.length === 0);
                    }, 800);
                }, 1200);
            };
        }

        /**
         * Navigates to a specific view by index (used for zone-based navigation).
         * @param {number} targetIndex - The index of the view to navigate to
         */
        function navigateToView(targetIndex) {
            if (targetIndex === currentViewIndex) {
                console.log('Already at target view');
                return;
            }

            if (targetIndex < 0 || targetIndex >= currentLessonViews.length) {
                console.error(`Invalid target index: ${targetIndex}`);
                return;
            }

            // Add current view to history before navigating
            viewHistory.push(currentViewIndex);
            console.log(`Navigating from view ${currentViewIndex} to view ${targetIndex}. History:`, viewHistory);

            zonesOverlay.innerHTML = '';
            simulationContainer.classList.remove('has-zones');

            const targetView = currentLessonViews[targetIndex];

            nextImage.classList.add('zoom-out-blurry');
            nextImage.style.opacity = '0';
            nextImage.src = targetView.imageUrl;

            nextImage.onload = () => {
                mainImage.classList.add('zoom-in');

                setTimeout(() => {
                    mainImage.classList.add('crossfade-out');
                    nextImage.classList.add('crossfade-in');
                    nextImage.style.opacity = '1';

                    setTimeout(() => {
                        currentViewIndex = targetIndex;
                        instructionText.textContent = targetView.description;

                        mainImage.src = targetView.imageUrl;
                        mainImage.classList.remove('zoom-in', 'crossfade-out');
                        mainImage.classList.add('zoom-out-blurry');
                        mainImage.style.opacity = '1';

                        nextImage.style.opacity = '0';
                        nextImage.classList.remove('crossfade-in', 'zoom-out-blurry');

                        awaitingFocusAdjustment = true;

                        const randomStart = Math.random() > 0.5
                            ? Math.floor(Math.random() * 30) + 10  // 10-40 range
                            : Math.floor(Math.random() * 30) + 60; // 60-90 range
                        focusSlider.value = randomStart;

                        const initialBlur = calculateBlurAmount(randomStart);
                        const initialScale = calculateScale(randomStart);
                        mainImage.style.filter = `blur(${initialBlur}px)`;
                        mainImage.style.transform = `scale(${initialScale})`;

                        mainImage.classList.add('adjusting-focus');
                        focusSliderContainer.classList.add('visible');
                        backButton.classList.toggle('hidden', viewHistory.length === 0);
                    }, 800);
                }, 1200);
            };
        }

        /**
         * Calculates the blur amount based on slider position.
         */
        function calculateBlurAmount(sliderValue) {
            const distance = Math.abs(sliderValue - optimalFocusValue);
            if (distance <= 5) {
                return distance * 0.5;
            } else {
                return 2.5 + (distance - 5) * 0.4;
            }
        }

        /**
         * Calculates the scale transformation based on slider position.
         * Always starts zoomed in (large scale) for better microscope UX.
         */
        function calculateScale(sliderValue) {
            const distance = Math.abs(sliderValue - optimalFocusValue);
            // At optimal focus: scale = 1.0 (normal size)
            // Away from optimal focus: scale increases (zoomed in)
            // Maximum zoom at extremes: 1.5x
            return 1.0 + (distance / 100) * 1.0;
        }

        /**
         * Updates the image blur and scale based on slider position.
         */
        function updateFocusBlur() {
            if (!awaitingFocusAdjustment) return;

            const blurAmount = calculateBlurAmount(focusSlider.value);
            const scale = calculateScale(focusSlider.value);

            mainImage.style.filter = `blur(${blurAmount}px)`;
            mainImage.style.transform = `scale(${scale})`;

            const distance = Math.abs(focusSlider.value - optimalFocusValue);
            const currentView = currentLessonViews[currentViewIndex];

            if (distance <= 5) {
                createZoneOverlays(currentView.zones);
            } else {
                zonesOverlay.innerHTML = '';
                simulationContainer.classList.remove('has-zones');
            }
        }

        /**
         * Renders a specific image and description in the simulation view.
         */
        function renderView(viewIndex) {
            if (viewIndex < 0 || viewIndex >= currentLessonViews.length) return;

            const view = currentLessonViews[viewIndex];
            currentViewIndex = viewIndex;

            // Reset any ongoing animations
            awaitingFocusAdjustment = false;
            focusSliderContainer.classList.remove('visible');
            mainImage.className = 'microscope-image';
            mainImage.style.filter = ''; // Clear any blur
            mainImage.style.transform = ''; // Clear any scale
            simulationContainer.style.backgroundColor = '';

            instructionText.textContent = view.description;
            mainImage.src = view.imageUrl;

            mainImage.onload = () => {
                console.log(`Image loaded: ${mainImage.naturalWidth}x${mainImage.naturalHeight}`);

                // Create clickable zones if they exist
                createZoneOverlays(view.zones);
                // Show back button if there's history or if not at the first view
                backButton.classList.toggle('hidden', viewHistory.length === 0 && viewIndex === 0);
            };
        }

        // --- EVENT LISTENERS ---
        // Click anywhere to advance (only when no zones are present)
        simulationContainer.addEventListener('click', (e) => {
            console.log('simulationContainer clicked, target:', e.target);

            // Only advance if clicking the container directly (not zones or buttons)
            if (e.target === simulationContainer || e.target === mainImage) {
                const currentView = currentLessonViews[currentViewIndex];

                console.log('Current view zones:', currentView?.zones);

                // Only allow click-to-advance if there are no zones
                if (!currentView || !currentView.zones || currentView.zones.length === 0) {
                    console.log('No zones present, advancing to next view');
                    renderView(currentViewIndex + 1);
                } else {
                    console.log('Zones present, click-to-advance disabled. Zones:', currentView.zones.length);
                }
            }
        });

        focusSlider.addEventListener('input', updateFocusBlur);

        backButton.addEventListener('click', (e) => {
            e.stopPropagation();

            // Use history stack if available, otherwise go to previous sequential view
            if (viewHistory.length > 0) {
                const previousViewIndex = viewHistory.pop();
                console.log(`Going back to view ${previousViewIndex}. Remaining history:`, viewHistory);
                renderView(previousViewIndex);
            } else if (currentViewIndex > 0) {
                // Fallback to sequential navigation if no history
                renderView(currentViewIndex - 1);
            }
        });

        backToLessonsButton.addEventListener('click', () => {
            simulationView.style.display = 'none';
            landingPage.style.display = 'block';
            currentViewIndex = -1;
            currentLessonViews = [];
            zonesOverlay.innerHTML = '';
            awaitingFocusAdjustment = false;
            focusSliderContainer.classList.remove('visible');
            mainImage.style.filter = '';
            mainImage.style.transform = '';
            mainImage.classList.remove('adjusting-focus');

            // Remove loading spinners from all lesson cards
            const allCards = lessonCardsContainer.querySelectorAll('.lesson-card');
            allCards.forEach(card => hideCardLoader(card));
        });

        // --- INITIALIZATION ---
        window.addEventListener('load', () => {
            try {
                if (TOOL_MODE === 'coordinates') {
                    initializeCoordinateHelper();
                    return;
                }
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    google.script.run
                        .withSuccessHandler(buildLandingPage)
                        .withFailureHandler(onScriptRunFailure)
                        .getLessons();
                } else {
                    console.error('Google Apps Script API not available');
                    lessonCardsContainer.innerHTML = '<p class="text-red-500 col-span-full text-center">Unable to connect to Google Apps Script. Please refresh.</p>';
                    loaderContainer.style.display = 'none';
                }
            } catch (error) {
                console.error('Initialization error:', error);
                if (loaderContainer) loaderContainer.style.display = 'none';
                if (lessonCardsContainer) {
                    lessonCardsContainer.innerHTML = '<p class="text-red-500 col-span-full text-center">An error occurred during initialization. Please refresh.</p>';
                }
            }
        });

        // ==============================
        // COORDINATE HELPER FUNCTIONALITY
        // ==============================

        let coordHelperState = {
            canvas: null, ctx: null, image: null, zones: [], isDrawing: false,
            startX: 0, startY: 0, currentZone: null, initialized: false,
            currentLesson: null, currentImageIndex: null, currentImageDesc: null,
            lessonImages: [], // Store all images in the lesson for target selection
            drawMode: 'rect', // 'rect' or 'poly'
            currentPolygon: [], // Array of points for the polygon being drawn
        };

        function buildCoordinateHelperLandingPage(lessons) {
            const coordLoaderContainer = document.getElementById('coord-loader-container');
            const coordLessonCardsContainer = document.getElementById('coord-lesson-cards-container');

            coordLoaderContainer.style.display = 'none';
            coordLessonCardsContainer.innerHTML = '';

            if (lessons.length > 0 && lessons[0].error) {
                coordLessonCardsContainer.innerHTML = `<p class="text-red-500 col-span-full text-center">${lessons[0].error}</p>`;
                return;
            }

            lessons.forEach(lesson => {
                const card = document.createElement('div');
                card.className = 'lesson-card bg-gray-50 dark:bg-gray-700 rounded-lg shadow-md overflow-hidden cursor-pointer';
                card.innerHTML = `
                    <img src="${lesson.previewImage || 'https://placehold.co/600x400/eeeeee/333333?text=No+Image'}" alt="${lesson.name}" class="w-full h-40 object-cover" onerror="this.src='https://placehold.co/600x400/eeeeee/333333?text=Image+Error'">
                    <div class="p-6 text-center">
                        <h3 class="font-bold text-lg">${lesson.name}</h3>
                        <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">${lesson.description || 'No description available.'}</p>
                    </div>
                `;
                card.addEventListener('click', () => {
                    showCardLoader(card);
                    selectLessonForCoordinates(lesson.name);
                });
                coordLessonCardsContainer.appendChild(card);
            });
        }

        function selectLessonForCoordinates(lessonName) {
            document.getElementById('coord-lesson-selection').classList.add('hidden');
            document.getElementById('coord-image-selection').classList.remove('hidden');
            document.getElementById('coord-lesson-title').textContent = lessonName;
            coordHelperState.currentLesson = lessonName;
            
            showSkeletonLoader(document.getElementById('coord-images-grid'), 2, 'image');
            
            google.script.run
                .withSuccessHandler(displayImagesForCoordinates)
                .withFailureHandler((err) => {
                    document.getElementById('coord-images-grid').innerHTML = '';
                    onScriptRunFailure(err);
                })
                .getLessonDataForCoordinates(lessonName);
        }

        function displayImagesForCoordinates(images) {
            const coordImagesGrid = document.getElementById('coord-images-grid');
            coordImagesGrid.innerHTML = '';

            // Store images for target selection
            coordHelperState.lessonImages = images;

            if (images.length === 0) {
                coordImagesGrid.innerHTML = '<p class="text-gray-500 col-span-full text-center">This lesson has no images.</p>';
                return;
            }

            images.forEach((image, idx) => {
                const imageCard = document.createElement('div');
                imageCard.className = 'lesson-card bg-gray-50 dark:bg-gray-700 rounded-lg shadow-md overflow-hidden cursor-pointer';
                imageCard.innerHTML = `
                    <img src="${image.imageUrl}" alt="${image.description}" class="w-full h-48 object-cover" onerror="this.src='https://placehold.co/600x400/eeeeee/333333?text=Image+Error'">
                    <div class="p-6">
                        <h3 class="font-semibold text-md">Image ${image.index + 1}</h3>
                        <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">${image.description}</p>
                    </div>
                `;
                imageCard.addEventListener('click', () => {
                    showCardLoader(imageCard);
                    selectImageForCoordinates(image.imageUrl, image.description, image.index);
                });
                coordImagesGrid.appendChild(imageCard);
            });
        }

        function selectImageForCoordinates(imageUrl, description, imageIndex) {
            document.getElementById('coord-image-selection').classList.add('hidden');
            document.getElementById('coord-canvas-editor').classList.remove('hidden');
            document.getElementById('coord-canvas-title').textContent = `Zone Editor: ${coordHelperState.currentLesson}`;
            document.getElementById('coord-canvas-subtitle').textContent = `Loading image...`;
            document.getElementById('json-lesson-name').textContent = coordHelperState.currentLesson;
            document.getElementById('json-image-index').textContent = `Image ${imageIndex + 1}`;
            document.getElementById('json-image-desc').textContent = description;

            coordHelperState.currentImageIndex = imageIndex;
            coordHelperState.currentImageDesc = description;
            coordHelperState.zones = [];
            updateZonesList();
            updateJsonOutput();
            
            const canvasLoader = document.getElementById('canvas-loader');
            canvasLoader.classList.remove('hidden');

            google.script.run
                .withSuccessHandler((base64DataUrl) => {
                    canvasLoader.classList.add('hidden');
                    if (base64DataUrl) {
                        document.getElementById('coord-canvas-subtitle').textContent = `Image ${imageIndex + 1}: ${description}`;
                        loadCoordinateImage(base64DataUrl);
                    } else {
                        document.getElementById('coord-canvas-subtitle').textContent = 'Error loading image';
                        onScriptRunFailure({ message: 'Server failed to load image data.' });
                    }
                })
                .withFailureHandler((err) => {
                    canvasLoader.classList.add('hidden');
                    onScriptRunFailure(err);
                })
                .getImageAsBase64(imageUrl);
        }

        function initializeCoordinateHelper() {
            if (coordHelperState.initialized) return;

            landingPage.style.display = 'none';
            simulationView.style.display = 'none';

            const coordHelperView = document.getElementById('coordinate-helper-view');
            coordHelperView.classList.remove('hidden');

            const canvas = document.getElementById('coord-canvas');
            coordHelperState.canvas = canvas;
            coordHelperState.ctx = canvas.getContext('2d');

            canvas.addEventListener('mousedown', handleCanvasMouseDown);
            canvas.addEventListener('mousemove', handleCanvasMouseMove);
            canvas.addEventListener('mouseup', handleCanvasMouseUp);

            // Drawing mode buttons
            const rectBtn = document.getElementById('draw-mode-rect');
            const polyBtn = document.getElementById('draw-mode-poly');

            rectBtn.classList.add('draw-mode-btn', 'active');
            polyBtn.classList.add('draw-mode-btn');

            rectBtn.addEventListener('click', () => {
                coordHelperState.drawMode = 'rect';
                rectBtn.classList.add('active');
                polyBtn.classList.remove('active');
                coordHelperState.currentPolygon = []; // Clear any partial polygon
                redrawCanvas();
            });

            polyBtn.addEventListener('click', () => {
                coordHelperState.drawMode = 'poly';
                polyBtn.classList.add('active');
                rectBtn.classList.remove('active');
            });

            coordHelperState.initialized = true;

            google.script.run
                .withSuccessHandler(buildCoordinateHelperLandingPage)
                .withFailureHandler(onScriptRunFailure)
                .getLessons();
        }

        function loadCoordinateImage(dataUrl) {
            const img = new Image();
            img.onload = () => {
                coordHelperState.image = img;
                const maxWidth = 768;
                const aspectRatio = img.height / img.width;
                coordHelperState.canvas.width = Math.min(img.width, maxWidth);
                coordHelperState.canvas.height = coordHelperState.canvas.width * aspectRatio;
                redrawCanvas();
            };
            img.onerror = () => onScriptRunFailure({ message: 'Failed to load image into canvas.'});
            img.src = dataUrl;
        }

        function redrawCanvas() {
            if (!coordHelperState.image) return;
            const { ctx, canvas, image, zones, currentZone } = coordHelperState;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
            zones.forEach((zone, index) => drawZone(zone, index, false));
            if (currentZone) drawZone(currentZone, zones.length, true);
        }

        function drawZone(zone, index, isTemporary) {
            const { ctx, canvas } = coordHelperState;
            const x = (zone.x / 100) * canvas.width;
            const y = (zone.y / 100) * canvas.height;
            const width = (zone.width / 100) * canvas.width;
            const height = (zone.height / 100) * canvas.height;
            ctx.strokeStyle = isTemporary ? '#fbbf24' : '#3b82f6';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, height);
            ctx.fillStyle = isTemporary ? 'rgba(251, 191, 36, 0.2)' : 'rgba(59, 130, 246, 0.2)';
            ctx.fillRect(x, y, width, height);
            if (zone.label) {
                ctx.fillStyle = '#000';
                ctx.font = 'bold 14px Inter, sans-serif';
                ctx.fillText(zone.label, x + 5, y + 20);
            }
        }

        function handleCanvasMouseDown(e) {
            if (!coordHelperState.image) return;

            if (coordHelperState.drawMode === 'poly') {
                handlePolygonClick(e, coordHelperState);
                return;
            }

            const rect = coordHelperState.canvas.getBoundingClientRect();
            const scaleX = coordHelperState.canvas.width / rect.width;
            const scaleY = coordHelperState.canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            coordHelperState.isDrawing = true;
            coordHelperState.startX = x;
            coordHelperState.startY = y;
            coordHelperState.currentZone = null;
        }


        function handlePolygonClick(e, state) {
            const rect = state.canvas.getBoundingClientRect();
            const scaleX = state.canvas.width / rect.width;
            const scaleY = state.canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            const point = {
                x: (x / state.canvas.width) * 100,
                y: (y / state.canvas.height) * 100
            };

            if (state.currentPolygon.length > 0) {
                const firstPoint = state.currentPolygon[0];
                const firstPointCanvasX = (firstPoint.x / 100) * state.canvas.width;
                const firstPointCanvasY = (firstPoint.y / 100) * state.canvas.height;
                const distance = Math.sqrt(Math.pow(x - firstPointCanvasX, 2) + Math.pow(y - firstPointCanvasY, 2));

                if (distance < 10) { // Close polygon
                    const newZone = {
                        type: 'poly',
                        points: state.currentPolygon,
                        label: ''
                    };

                    // Ask for label first
                    showCustomModal({
                        title: 'Enter Zone Label',
                        message: 'Please provide an optional label for this zone.',
                        type: 'prompt',
                        placeholder: 'e.g., Nucleus'
                    }).then(function(label) {
                        if (label !== null) {
                            if (label.trim() !== '') {
                                newZone.label = label.trim();
                            }

                            // Then ask for target image (if lessonImages available)
                            if (state.lessonImages && state.lessonImages.length > 0) {
                                const imageOptions = [
                                    { value: '', label: 'None (Sequential navigation)' },
                                    { value: 'banner', label: 'üìù Display Text Banner' },
                                    ...state.lessonImages.map(img => ({
                                        value: img.index.toString(),
                                        label: `Image ${img.index + 1}: ${img.description}`
                                    }))
                                ];

                                showCustomModal({
                                    title: 'Select Action',
                                    message: 'What should happen when this zone is clicked?',
                                    type: 'select',
                                    options: imageOptions
                                }).then(function(targetView) {
                                    if (targetView !== null) {
                                        // Check if banner option was selected
                                        if (targetView === 'banner') {
                                            // Ask for banner text
                                            showCustomModal({
                                                title: 'Banner Text',
                                                message: 'Enter the text to display in the banner:',
                                                type: 'prompt',
                                                placeholder: 'e.g., This is the mitochondria, the powerhouse of the cell!'
                                            }).then(function(bannerText) {
                                                if (bannerText !== null && bannerText.trim() !== '') {
                                                    // Ask for banner position
                                                    showCustomModal({
                                                        title: 'Banner Position',
                                                        message: 'Where should the banner appear?',
                                                        type: 'select',
                                                        options: [
                                                            { value: 'top', label: 'Top of screen' },
                                                            { value: 'bottom', label: 'Bottom of screen' }
                                                        ]
                                                    }).then(function(position) {
                                                        if (position !== null) {
                                                            newZone.actionType = 'banner';
                                                            newZone.bannerText = bannerText.trim();
                                                            newZone.bannerPosition = position;

                                                            state.zones.push(newZone);
                                                            state.currentPolygon = [];

                                                            if (state === coordHelperState) {
                                                                updateZonesList();
                                                                updateJsonOutput();
                                                                redrawCanvas();
                                                            } else if (state === adminState) {
                                                                updateAdminZonesList();
                                                                redrawAdminCanvas();
                                                            }
                                                        } else {
                                                            state.currentPolygon = [];
                                                            if (state === coordHelperState) {
                                                                redrawCanvas();
                                                            } else if (state === adminState) {
                                                                redrawAdminCanvas();
                                                            }
                                                        }
                                                    });
                                                } else {
                                                    state.currentPolygon = [];
                                                    if (state === coordHelperState) {
                                                        redrawCanvas();
                                                    } else if (state === adminState) {
                                                        redrawAdminCanvas();
                                                    }
                                                }
                                            });
                                        }
                                        // Add targetView only if a specific image was selected
                                        else if (targetView !== '') {
                                            newZone.targetView = parseInt(targetView);

                                            state.zones.push(newZone);
                                            state.currentPolygon = [];

                                            if (state === coordHelperState) {
                                                updateZonesList();
                                                updateJsonOutput();
                                                redrawCanvas();
                                            } else if (state === adminState) {
                                                updateAdminZonesList();
                                                redrawAdminCanvas();
                                            }
                                        }
                                        // Sequential navigation (no targetView)
                                        else {
                                            state.zones.push(newZone);
                                            state.currentPolygon = [];

                                            if (state === coordHelperState) {
                                                updateZonesList();
                                                updateJsonOutput();
                                                redrawCanvas();
                                            } else if (state === adminState) {
                                                updateAdminZonesList();
                                                redrawAdminCanvas();
                                            }
                                        }
                                    } else {
                                        state.currentPolygon = [];
                                        if (state === coordHelperState) {
                                            redrawCanvas();
                                        } else if (state === adminState) {
                                            redrawAdminCanvas();
                                        }
                                    }
                                });
                            } else {
                                // No lessonImages available, just add the zone
                                state.zones.push(newZone);
                                state.currentPolygon = [];

                                if (state === coordHelperState) {
                                    updateZonesList();
                                    updateJsonOutput();
                                    redrawCanvas();
                                } else if (state === adminState) {
                                    updateAdminZonesList();
                                    redrawAdminCanvas();
                                }
                            }
                        } else {
                            // User cancelled, clear polygon
                            state.currentPolygon = [];
                            if (state === coordHelperState) {
                                redrawCanvas();
                            } else if (state === adminState) {
                                redrawAdminCanvas();
                            }
                        }
                    });
                    return;
                }
            }

            state.currentPolygon.push(point);
            if (state === coordHelperState) {
                redrawCanvas();
            } else if (state === adminState) {
                redrawAdminCanvas();
            }
        }

        function handleCanvasMouseMove(e) {
            if (coordHelperState.drawMode === 'poly' || !coordHelperState.isDrawing || !coordHelperState.image) return;
            const rect = coordHelperState.canvas.getBoundingClientRect();
            const scaleX = coordHelperState.canvas.width / rect.width;
            const scaleY = coordHelperState.canvas.height / rect.height;
            const currentX = (e.clientX - rect.left) * scaleX;
            const currentY = (e.clientY - rect.top) * scaleY;
            const x = Math.min(coordHelperState.startX, currentX);
            const y = Math.min(coordHelperState.startY, currentY);
            const width = Math.abs(currentX - coordHelperState.startX);
            const height = Math.abs(currentY - coordHelperState.startY);
            coordHelperState.currentZone = {
                type: 'rect',
                x: (x / coordHelperState.canvas.width) * 100,
                y: (y / coordHelperState.canvas.height) * 100,
                width: (width / coordHelperState.canvas.width) * 100,
                height: (height / coordHelperState.canvas.height) * 100,
                label: ''
            };
            redrawCanvas();
        }

        function handleCanvasMouseUp(e) {
            if (coordHelperState.drawMode === 'poly' || !coordHelperState.isDrawing || !coordHelperState.image) return;
            coordHelperState.isDrawing = false;

            if (coordHelperState.currentZone && coordHelperState.currentZone.width > 1 && coordHelperState.currentZone.height > 1) {
                // First ask for label
                showCustomModal({
                    title: 'Enter Zone Label',
                    message: 'Please provide an optional label for this zone.',
                    type: 'prompt',
                    placeholder: 'e.g., Nucleus'
                }).then(function(label) {
                    if(label !== null) { // Only proceed if user didn't cancel
                        // Trim and validate label
                        const trimmedLabel = label.trim();
                        console.log('Zone label entered:', label, '| Trimmed:', trimmedLabel);

                        // Only set label if non-empty, otherwise leave undefined for default fallback
                        if (trimmedLabel !== '') {
                            coordHelperState.currentZone.label = trimmedLabel;
                        }

                        // Then ask for target image
                        const imageOptions = [
                            { value: '', label: 'None (Sequential navigation)' },
                            { value: 'banner', label: 'üìù Display Text Banner' },
                            ...coordHelperState.lessonImages.map(img => ({
                                value: img.index.toString(),
                                label: `Image ${img.index + 1}: ${img.description}`
                            }))
                        ];

                        showCustomModal({
                            title: 'Select Action',
                            message: 'What should happen when this zone is clicked?',
                            type: 'select',
                            options: imageOptions
                        }).then(function(targetView) {
                            if (targetView !== null) {
                                // Check if banner option was selected
                                if (targetView === 'banner') {
                                    // Ask for banner text
                                    showCustomModal({
                                        title: 'Banner Text',
                                        message: 'Enter the text to display in the banner:',
                                        type: 'prompt',
                                        placeholder: 'e.g., This is the mitochondria, the powerhouse of the cell!'
                                    }).then(function(bannerText) {
                                        if (bannerText !== null && bannerText.trim() !== '') {
                                            // Ask for banner position
                                            showCustomModal({
                                                title: 'Banner Position',
                                                message: 'Where should the banner appear?',
                                                type: 'select',
                                                options: [
                                                    { value: 'top', label: 'Top of screen' },
                                                    { value: 'bottom', label: 'Bottom of screen' }
                                                ]
                                            }).then(function(position) {
                                                if (position !== null) {
                                                    coordHelperState.currentZone.actionType = 'banner';
                                                    coordHelperState.currentZone.bannerText = bannerText.trim();
                                                    coordHelperState.currentZone.bannerPosition = position;

                                                    coordHelperState.currentZone.x = Math.round(coordHelperState.currentZone.x * 100) / 100;
                                                    coordHelperState.currentZone.y = Math.round(coordHelperState.currentZone.y * 100) / 100;
                                                    coordHelperState.currentZone.width = Math.round(coordHelperState.currentZone.width * 100) / 100;
                                                    coordHelperState.currentZone.height = Math.round(coordHelperState.currentZone.height * 100) / 100;

                                                    console.log('Adding banner zone to array:', coordHelperState.currentZone);
                                                    coordHelperState.zones.push(coordHelperState.currentZone);
                                                    console.log('Total zones:', coordHelperState.zones.length);

                                                    updateZonesList();
                                                    updateJsonOutput();
                                                }
                                                coordHelperState.currentZone = null;
                                                redrawCanvas();
                                            });
                                        } else {
                                            coordHelperState.currentZone = null;
                                            redrawCanvas();
                                        }
                                    });
                                }
                                // Add targetView only if a specific image was selected
                                else if (targetView !== '') {
                                    coordHelperState.currentZone.targetView = parseInt(targetView);

                                    coordHelperState.currentZone.x = Math.round(coordHelperState.currentZone.x * 100) / 100;
                                    coordHelperState.currentZone.y = Math.round(coordHelperState.currentZone.y * 100) / 100;
                                    coordHelperState.currentZone.width = Math.round(coordHelperState.currentZone.width * 100) / 100;
                                    coordHelperState.currentZone.height = Math.round(coordHelperState.currentZone.height * 100) / 100;

                                    console.log('Adding zone to array:', coordHelperState.currentZone);
                                    coordHelperState.zones.push(coordHelperState.currentZone);
                                    console.log('Total zones:', coordHelperState.zones.length, '| All zones:', coordHelperState.zones);

                                    updateZonesList();
                                    updateJsonOutput();

                                    coordHelperState.currentZone = null;
                                    redrawCanvas();
                                }
                                // Sequential navigation (no targetView)
                                else {
                                    coordHelperState.currentZone.x = Math.round(coordHelperState.currentZone.x * 100) / 100;
                                    coordHelperState.currentZone.y = Math.round(coordHelperState.currentZone.y * 100) / 100;
                                    coordHelperState.currentZone.width = Math.round(coordHelperState.currentZone.width * 100) / 100;
                                    coordHelperState.currentZone.height = Math.round(coordHelperState.currentZone.height * 100) / 100;

                                    console.log('Adding zone to array:', coordHelperState.currentZone);
                                    coordHelperState.zones.push(coordHelperState.currentZone);
                                    console.log('Total zones:', coordHelperState.zones.length, '| All zones:', coordHelperState.zones);

                                    updateZonesList();
                                    updateJsonOutput();

                                    coordHelperState.currentZone = null;
                                    redrawCanvas();
                                }
                            } else {
                                coordHelperState.currentZone = null;
                                redrawCanvas();
                            }
                        });
                    } else {
                        coordHelperState.currentZone = null;
                        redrawCanvas();
                    }
                });
            } else {
                coordHelperState.currentZone = null;
                redrawCanvas();
            }
        }

        function updateZonesList() {
            const zonesList = document.getElementById('zones-list');
            if (coordHelperState.zones.length === 0) {
                zonesList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No zones defined yet. Click and drag on the image to create zones.</p>';
                return;
            }
            zonesList.innerHTML = coordHelperState.zones.map((zone, index) => {
                let targetInfo = '';
                if (zone.actionType === 'banner') {
                    const preview = zone.bannerText.length > 50 ? zone.bannerText.substring(0, 50) + '...' : zone.bannerText;
                    targetInfo = `<br>‚Üí Banner (${zone.bannerPosition}): "${preview}"`;
                } else if (zone.targetView !== undefined && zone.targetView !== null) {
                    const targetImage = coordHelperState.lessonImages.find(img => img.index === zone.targetView);
                    targetInfo = targetImage
                        ? `<br>‚Üí Target: Image ${zone.targetView + 1} (${targetImage.description})`
                        : `<br>‚Üí Target: Image ${zone.targetView + 1}`;
                }

                let zoneDetails = '';
                if (zone.type === 'poly') {
                    zoneDetails = `Polygon with ${zone.points.length} points`;
                } else {
                    zoneDetails = `x: ${zone.x}%, y: ${zone.y}%<br>w: ${zone.width}%, h: ${zone.height}%`;
                }

                return `
                <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg flex justify-between items-start">
                    <div class="flex-1">
                        <div class="font-semibold text-sm">${zone.label || `Zone ${index + 1}`}</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                            ${zoneDetails}${targetInfo}
                        </div>
                    </div>
                    <div class="flex gap-1 ml-2">
                        <button onclick="editZone(${index})" class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                            Edit
                        </button>
                        <button onclick="deleteZone(${index})" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">
                            Delete
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        document.getElementById('clear-zones').addEventListener('click', () => {
            coordHelperState.zones = [];
            coordHelperState.currentPolygon = [];
            updateZonesList();
            updateJsonOutput();
            redrawCanvas();
        });
        
        function createZoneOverlays(zones) {
            zonesOverlay.innerHTML = ''; // Clear existing zones

            console.log('createZoneOverlays called with zones:', zones);

            if (!zones || zones.length === 0) {
                console.log('No zones to create');
                simulationContainer.classList.remove('has-zones');
                return;
            }

            simulationContainer.classList.add('has-zones');
            console.log(`Creating ${zones.length} zone overlays`);

            // Get the actual dimensions of the container and the image
            const containerRect = simulationContainer.getBoundingClientRect();
            const imageRect = mainImage.getBoundingClientRect();

            // Calculate the offset and scale of the image within the container
            // (due to object-contain, the image might be smaller and centered)
            const offsetX = imageRect.left - containerRect.left;
            const offsetY = imageRect.top - containerRect.top;
            const imageWidth = imageRect.width;
            const imageHeight = imageRect.height;
            const containerWidth = containerRect.width;
            const containerHeight = containerRect.height;

            console.log('Container dimensions:', containerWidth, 'x', containerHeight);
            console.log('Image dimensions:', imageWidth, 'x', imageHeight);
            console.log('Image offset:', offsetX, ',', offsetY);

            zones.forEach((zone, index) => {
                console.log(`Zone ${index}:`, zone);

                if (zone.type === 'poly') {
                    const svgNS = "http://www.w3.org/2000/svg";
                    const svg = document.createElementNS(svgNS, "svg");
                    svg.setAttribute('class', 'polygon-zone');
                    svg.style.width = '100%';
                    svg.style.height = '100%';
                    svg.style.position = 'absolute';
                    svg.style.left = '0';
                    svg.style.top = '0';
                    svg.style.pointerEvents = 'none';

                    const polygon = document.createElementNS(svgNS, "polygon");
                    // Convert polygon points from image-relative percentages to container-relative pixels
                    const points = zone.points.map(p => {
                        // Step 1: Convert percentage to pixels relative to image
                        const pxInImage = (p.x / 100) * imageWidth;
                        const pyInImage = (p.y / 100) * imageHeight;
                        // Step 2: Add image offset within container
                        const pxInContainer = pxInImage + offsetX;
                        const pyInContainer = pyInImage + offsetY;
                        return `${pxInContainer},${pyInContainer}`;
                    }).join(' ');
                    polygon.setAttribute("points", points);
                    polygon.setAttribute("class", "polygon-shape");
                    polygon.style.fill = 'transparent';
                    polygon.style.stroke = 'transparent';
                    polygon.style.strokeWidth = '2px';
                    polygon.style.pointerEvents = 'all';
                    polygon.style.cursor = 'pointer';
                    polygon.style.transition = 'fill 0.3s ease, stroke 0.3s ease';

                    // Add hover effect inline since CSS :hover doesn't work well with SVG in some browsers
                    polygon.addEventListener('mouseenter', () => {
                        polygon.style.fill = 'rgba(59, 130, 246, 0.2)';
                        polygon.style.stroke = 'rgba(59, 130, 246, 0.5)';
                        // Show label
                        const label = svg.querySelector('.zone-label');
                        if (label) {
                            label.style.opacity = '1';
                            label.style.transform = 'translateX(-50%) translateY(-12px)';
                        }
                    });
                    polygon.addEventListener('mouseleave', () => {
                        polygon.style.fill = 'transparent';
                        polygon.style.stroke = 'transparent';
                        // Hide label
                        const label = svg.querySelector('.zone-label');
                        if (label) {
                            label.style.opacity = '0';
                            label.style.transform = 'translateX(-50%) translateY(-8px)';
                        }
                    });

                    // Add click handler for polygon zone
                    polygon.addEventListener('click', (e) => {
                        console.log(`Zone ${index} clicked!`);
                        e.stopPropagation();

                        // Check if zone displays a banner
                        if (zone.actionType === 'banner' && zone.bannerText) {
                            const position = zone.bannerPosition || 'bottom';
                            showZoneBanner(zone.bannerText, position);
                        }
                        // Check if zone has a specific target view
                        else if (zone.targetView !== undefined && zone.targetView !== null) {
                            const targetIndex = parseInt(zone.targetView);
                            if (targetIndex >= 0 && targetIndex < currentLessonViews.length) {
                                navigateToView(targetIndex);
                            } else {
                                console.error(`Invalid targetView ${targetIndex} for zone ${index}`);
                                zoomToNextView(); // Fallback to sequential navigation
                            }
                        } else {
                            // Default behavior: advance to next view sequentially
                            zoomToNextView();
                        }
                    });

                    svg.appendChild(polygon);

                    // Add label tooltip
                    const label = document.createElement('div');
                    label.className = 'zone-label';
                    label.textContent = zone.label || `Zone ${index + 1}`;
                    // Position label at the center of the polygon
                    const avgX = zone.points.reduce((sum, p) => sum + p.x, 0) / zone.points.length;
                    const avgY = zone.points.reduce((sum, p) => sum + p.y, 0) / zone.points.length;
                    const labelX = (avgX / 100) * imageWidth + offsetX;
                    const labelY = (avgY / 100) * imageHeight + offsetY;
                    label.style.position = 'absolute';
                    label.style.left = `${labelX}px`;
                    label.style.top = `${labelY}px`;
                    svg.appendChild(label);

                    zonesOverlay.appendChild(svg);

                } else { // rect
                    const zoneDiv = document.createElement('div');
                    zoneDiv.className = 'clickable-zone';

                    // Calculate zone position relative to the actual image, not the container
                    // Zone percentages are relative to the image, so we need to:
                    // 1. Convert percentages to pixels relative to the image
                    // 2. Add the image offset within the container
                    // 3. Convert back to percentages relative to the container
                    const zoneLeftPx = (zone.x / 100) * imageWidth + offsetX;
                    const zoneTopPx = (zone.y / 100) * imageHeight + offsetY;
                    const zoneWidthPx = (zone.width / 100) * imageWidth;
                    const zoneHeightPx = (zone.height / 100) * imageHeight;

                    // Convert to percentages of the container
                    const zoneLeftPercent = (zoneLeftPx / containerWidth) * 100;
                    const zoneTopPercent = (zoneTopPx / containerHeight) * 100;
                    const zoneWidthPercent = (zoneWidthPx / containerWidth) * 100;
                    const zoneHeightPercent = (zoneHeightPx / containerHeight) * 100;

                    zoneDiv.style.left = `${zoneLeftPercent}%`;
                    zoneDiv.style.top = `${zoneTopPercent}%`;
                    zoneDiv.style.width = `${zoneWidthPercent}%`;
                    zoneDiv.style.height = `${zoneHeightPercent}%`;

                    console.log(`Zone ${index} positioned at: left=${zoneLeftPercent.toFixed(2)}%, top=${zoneTopPercent.toFixed(2)}%, width=${zoneWidthPercent.toFixed(2)}%, height=${zoneHeightPercent.toFixed(2)}%`);

                    // Add label tooltip
                    const label = document.createElement('div');
                    label.className = 'zone-label';
                    label.textContent = zone.label || `Zone ${index + 1}`;
                    zoneDiv.appendChild(label);
                    zonesOverlay.appendChild(zoneDiv);

                    // Add click handler for rectangular zone
                    zoneDiv.addEventListener('click', (e) => {
                        console.log(`Zone ${index} clicked!`);
                        e.stopPropagation();

                        // Check if zone displays a banner
                        if (zone.actionType === 'banner' && zone.bannerText) {
                            const position = zone.bannerPosition || 'bottom';
                            showZoneBanner(zone.bannerText, position);
                        }
                        // Check if zone has a specific target view
                        else if (zone.targetView !== undefined && zone.targetView !== null) {
                            const targetIndex = parseInt(zone.targetView);
                            if (targetIndex >= 0 && targetIndex < currentLessonViews.length) {
                                navigateToView(targetIndex);
                            } else {
                                console.error(`Invalid targetView ${targetIndex} for zone ${index}`);
                                zoomToNextView(); // Fallback to sequential navigation
                            }
                        } else {
                            // Default behavior: advance to next view sequentially
                            zoomToNextView();
                        }
                    });
                }

            });
        }

        function editZone(index) {
            const zone = coordHelperState.zones[index];
            if (!zone) return;

            // Prepare image options for the action dropdown
            const imageOptions = [
                { value: '', label: 'None (Sequential navigation)' },
                { value: 'banner', label: 'üìù Display Text Banner' },
                ...coordHelperState.lessonImages.map(img => ({
                    value: img.index.toString(),
                    label: `Image ${img.index + 1}: ${img.description}`
                }))
            ];

            // Determine current action value
            let currentAction = '';
            if (zone.actionType === 'banner') {
                currentAction = 'banner';
            } else if (zone.targetView !== undefined) {
                currentAction = zone.targetView.toString();
            }

            // First modal: Label + Action selection
            showCustomModal({
                title: 'Edit Zone',
                message: 'Update the zone label and click action:',
                type: 'multi',
                fields: [
                    {
                        type: 'text',
                        id: 'label',
                        label: 'Zone Label',
                        placeholder: zone.label || `Zone ${index + 1}`,
                        value: zone.label || ''
                    },
                    {
                        type: 'select',
                        id: 'action',
                        label: 'Click Action',
                        value: currentAction,
                        options: imageOptions
                    }
                ]
            }).then(function(values) {
                if (values !== null) {
                    const newLabel = values.label.trim();
                    const selectedAction = values.action;

                    // Update label
                    if (newLabel !== '') {
                        coordHelperState.zones[index].label = newLabel;
                    } else {
                        delete coordHelperState.zones[index].label;
                    }

                    // Handle banner action
                    if (selectedAction === 'banner') {
                        // Second modal: Banner text + position
                        showCustomModal({
                            title: 'Configure Text Banner',
                            message: 'Enter the banner text and position:',
                            type: 'multi',
                            fields: [
                                {
                                    type: 'text',
                                    id: 'bannerText',
                                    label: 'Banner Text',
                                    placeholder: 'e.g., This is the mitochondria, the powerhouse of the cell!',
                                    value: zone.bannerText || ''
                                },
                                {
                                    type: 'select',
                                    id: 'bannerPosition',
                                    label: 'Banner Position',
                                    value: zone.bannerPosition || 'bottom',
                                    options: [
                                        { value: 'top', label: 'Top of screen' },
                                        { value: 'bottom', label: 'Bottom of screen' }
                                    ]
                                }
                            ]
                        }).then(function(bannerValues) {
                            if (bannerValues !== null && bannerValues.bannerText.trim() !== '') {
                                // Remove old properties
                                delete coordHelperState.zones[index].targetView;
                                // Set banner properties
                                coordHelperState.zones[index].actionType = 'banner';
                                coordHelperState.zones[index].bannerText = bannerValues.bannerText.trim();
                                coordHelperState.zones[index].bannerPosition = bannerValues.bannerPosition;

                                console.log('Zone edited:', coordHelperState.zones[index]);
                                updateZonesList();
                                updateJsonOutput();
                                redrawCanvas();
                            }
                        });
                    }
                    // Handle image navigation
                    else if (selectedAction !== '') {
                        // Remove old banner properties
                        delete coordHelperState.zones[index].actionType;
                        delete coordHelperState.zones[index].bannerText;
                        delete coordHelperState.zones[index].bannerPosition;
                        // Set target view
                        coordHelperState.zones[index].targetView = parseInt(selectedAction);

                        console.log('Zone edited:', coordHelperState.zones[index]);
                        updateZonesList();
                        updateJsonOutput();
                        redrawCanvas();
                    }
                    // Handle sequential navigation (no action)
                    else {
                        // Remove all action properties
                        delete coordHelperState.zones[index].targetView;
                        delete coordHelperState.zones[index].actionType;
                        delete coordHelperState.zones[index].bannerText;
                        delete coordHelperState.zones[index].bannerPosition;

                        console.log('Zone edited:', coordHelperState.zones[index]);
                        updateZonesList();
                        updateJsonOutput();
                        redrawCanvas();
                    }
                }
            });
        }
        window.editZone = editZone;

        function deleteZone(index) {
            coordHelperState.zones.splice(index, 1);
            updateZonesList();
            updateJsonOutput();
            redrawCanvas();
        }
        window.deleteZone = deleteZone;

        function updateJsonOutput() {
            const zonesArrayOutput = document.getElementById('json-zones-array');
            const fullMetadataOutput = document.getElementById('json-full-metadata');
            zonesArrayOutput.value = JSON.stringify(coordHelperState.zones, null, 2);
            if (coordHelperState.currentLesson !== null) {
                const outputWithMetadata = {
                    lessonName: coordHelperState.currentLesson,
                    imageIndex: coordHelperState.currentImageIndex,
                    imageDescription: coordHelperState.currentImageDesc,
                    zones: coordHelperState.zones
                };
                fullMetadataOutput.value = JSON.stringify(outputWithMetadata, null, 2);
            } else {
                fullMetadataOutput.value = JSON.stringify({ zones: coordHelperState.zones }, null, 2);
            }
        }
        
        // ==============================
        // ADMIN LESSON MANAGEMENT
        // ==============================

        let adminState = {
            currentLesson: null,
            currentLessonTitle: null,
            currentImage: null,
            currentImageData: null,
            currentImageIndex: 0,
            canvas: null,
            ctx: null,
            zones: [],
            isDrawing: false,
            startX: 0,
            startY: 0,
            currentZone: null,
            folderId: null,
            lessonImages: [], // Store all images in the lesson for target selection
            drawMode: 'rect', // 'rect' or 'poly'
            currentPolygon: [], // Array of points for the polygon being drawn
        };

        /**
         * Shows the admin login modal
         */
        function showAdminLogin() {
            const modal = document.getElementById('admin-login-modal');
            modal.classList.remove('hidden');
            document.getElementById('admin-username').value = '';
            document.getElementById('admin-password').value = '';
            document.getElementById('admin-login-error').classList.add('hidden');
        }

        /**
         * Hides the admin login modal
         */
        function hideAdminLogin() {
            document.getElementById('admin-login-modal').classList.add('hidden');
        }

        /**
         * Handles admin login
         */
        function handleAdminLogin() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const errorDiv = document.getElementById('admin-login-error');
            const loginBtn = document.getElementById('admin-login-btn');

            if (!username || !password) {
                errorDiv.textContent = 'Please enter both username and password.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            showButtonLoader(loginBtn, 'Logging In...');

            google.script.run
                .withSuccessHandler((result) => {
                    hideButtonLoader(loginBtn);
                    if (result.success) {
                        hideAdminLogin();
                        showAdminLessonList();
                    } else {
                        errorDiv.textContent = result.message;
                        errorDiv.classList.remove('hidden');
                    }
                })
                .withFailureHandler((err) => {
                    hideButtonLoader(loginBtn);
                    onScriptRunFailure(err);
                })
                .authenticateAdmin(username, password);
        }

        /**
         * Shows the admin lesson list view
         */
        function showAdminLessonList() {
            // Hide all views
            landingPage.style.display = 'none';
            simulationView.style.display = 'none';
            document.getElementById('coordinate-helper-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');

            // Show lesson list sub-view, hide others
            document.getElementById('admin-lesson-list').classList.remove('hidden');
            document.getElementById('admin-lesson-form').classList.add('hidden');
            document.getElementById('admin-image-manager').classList.add('hidden');
            document.getElementById('admin-zone-editor').classList.add('hidden');

            // Load lessons
            loadAdminLessons();
        }

        /**
         * Loads lessons for admin view
         */
        function loadAdminLessons() {
            const loader = document.getElementById('admin-loader-container');
            const container = document.getElementById('admin-lesson-cards-container');

            loader.classList.remove('hidden');
            container.innerHTML = '';
            showSkeletonLoader(container, 3, 'lesson');

            google.script.run
                .withSuccessHandler((lessons) => {
                    loader.classList.add('hidden');
                    buildAdminLessonCards(lessons);
                })
                .withFailureHandler((err) => {
                     loader.classList.add('hidden');
                     container.innerHTML = '';
                     onScriptRunFailure(err);
                })
                .getLessons();
        }

        /**
         * Builds lesson cards for admin view
         */
        function buildAdminLessonCards(lessons) {
            const container = document.getElementById('admin-lesson-cards-container');
            container.innerHTML = '';

            if (lessons.length === 0 || (lessons.length > 0 && lessons[0].error)) {
                container.innerHTML = '<p class="text-gray-500 col-span-full text-center">No lessons found. Create your first lesson!</p>';
                return;
            }

            lessons.forEach(lesson => {
                const card = document.createElement('div');
                card.className = 'lesson-card bg-gray-50 dark:bg-gray-700 rounded-lg shadow-md overflow-hidden';
                card.innerHTML = `
                    <img src="${lesson.previewImage || 'https://placehold.co/600x400/eeeeee/333333?text=No+Image'}" alt="${lesson.name}" class="w-full h-40 object-cover" onerror="this.src='https://placehold.co/600x400/eeeeee/333333?text=Image+Error'">
                    <div class="p-6">
                        <h3 class="font-bold text-lg">${lesson.name}</h3>
                        <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">${lesson.description || 'No description'}</p>
                        <button onclick="editLesson(this, '${lesson.name.replace(/'/g, "&#39;")}')" class="mt-4 w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded hover:bg-blue-700 transition-all">
                            Edit Lesson
                        </button>
                        <button onclick="deleteLessonConfirm(this, '${lesson.name.replace(/'/g, "&#39;")}')" class="mt-2 w-full px-4 py-2 bg-red-600 text-white font-semibold rounded hover:bg-red-700 transition-all">
                            üóëÔ∏è Delete Lesson
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        /**
         * Shows the create lesson form
         */
        function showCreateLessonForm() {
            document.getElementById('admin-lesson-list').classList.add('hidden');
            document.getElementById('admin-lesson-form').classList.remove('hidden');
            document.getElementById('admin-form-title').textContent = 'Create New Lesson';
            document.getElementById('lesson-title-input').value = '';
            document.getElementById('lesson-description-input').value = '';
            adminState.currentLesson = null;
        }

        /**
         * Edits an existing lesson
         */
        function editLesson(button, lessonName) {
            showButtonLoader(button, 'Loading...');
            adminState.currentLessonTitle = lessonName;
            showImageManager(lessonName);
        }

        /**
         * Confirms and deletes an entire lesson
         */
        async function deleteLessonConfirm(button, lessonName) {
            const confirmed = await showCustomModal({
                title: '‚ö†Ô∏è Delete Entire Lesson?',
                message: `Are you sure you want to permanently delete the lesson "${lessonName}"?\n\nThis will:\n‚Ä¢ Delete all images from Google Drive\n‚Ä¢ Delete the lesson folder from Google Drive\n‚Ä¢ Remove the lesson from the spreadsheet\n\nThis action CANNOT be undone!`,
                type: 'confirm'
            });

            if (!confirmed) return;

            // Show loading state
            showButtonLoader(button, 'Deleting...');

            google.script.run
                .withSuccessHandler((result) => {
                    hideButtonLoader(button);
                    if (result.success) {
                        showCustomModal({
                            title: 'Success',
                            message: 'Lesson deleted successfully!',
                            type: 'confirm'
                        });
                        // Reload the lesson list
                        loadAdminLessons();
                    } else {
                        showCustomModal({
                            title: 'Error',
                            message: 'Failed to delete lesson: ' + result.message,
                            type: 'confirm'
                        });
                    }
                })
                .withFailureHandler((err) => {
                    hideButtonLoader(button);
                    onScriptRunFailure(err);
                })
                .deleteLesson(lessonName);
        }

        // Expose to global scope for inline onclick handlers
        window.editLesson = editLesson;
        window.deleteLessonConfirm = deleteLessonConfirm;

        /**
         * Saves a new lesson
         */
        function saveLesson() {
            const title = document.getElementById('lesson-title-input').value.trim();
            const description = document.getElementById('lesson-description-input').value.trim();
            const saveBtn = document.getElementById('admin-save-lesson-btn');

            if (!title) {
                showCustomModal({ title: 'Input Required', message: 'Please enter a lesson title.', type: 'confirm'});
                return;
            }
            
            showButtonLoader(saveBtn, 'Saving...');

            google.script.run
                .withSuccessHandler((result) => {
                    hideButtonLoader(saveBtn);
                    if (result.success) {
                        adminState.currentLessonTitle = title;
                        adminState.folderId = result.folderId;
                        showImageManager(title);
                    } else {
                        showCustomModal({ title: 'Error', message: 'Error creating lesson: ' + result.message, type: 'confirm'});
                    }
                })
                .withFailureHandler((err) => {
                    hideButtonLoader(saveBtn);
                    onScriptRunFailure(err);
                })
                .createLesson(title, description);
        }

        /**
         * Shows the image manager view
         */
        function showImageManager(lessonName, savedImageIndex = null, savedZones = null) {
            document.getElementById('admin-lesson-list').classList.add('hidden');
            document.getElementById('admin-lesson-form').classList.add('hidden');
            document.getElementById('admin-image-manager').classList.remove('hidden');
            document.getElementById('admin-zone-editor').classList.add('hidden');

            document.getElementById('admin-image-manager-title').textContent = 'Manage Images for: ' + lessonName;
            document.getElementById('admin-image-manager-subtitle').textContent = lessonName;

            // Clear image preview
            document.getElementById('image-preview-section').classList.add('hidden');
            adminState.currentImageData = null;
            document.getElementById('image-description-input').value = '';


            // Load existing images for this lesson
            loadExistingImages(lessonName, savedImageIndex, savedZones);
        }

        /**
         * Loads existing images for a lesson
         */
        function loadExistingImages(lessonName, savedImageIndex = null, savedZones = null) {
            showSkeletonLoader(document.getElementById('existing-images-list'), 2, 'image');
            google.script.run
                .withSuccessHandler((result) => {
                    if (result.success) {
                        displayExistingImages(result.data.images, savedImageIndex, savedZones);
                        adminState.currentImageIndex = result.data.images.length;
                    } else {
                        document.getElementById('existing-images-list').innerHTML = `<p class="text-red-500">${result.message}</p>`;
                    }
                })
                .withFailureHandler((err) => {
                    document.getElementById('existing-images-list').innerHTML = '';
                    onScriptRunFailure(err)
                })
                .getLessonForEditing(lessonName);
        }

        /**
         * Displays existing images in the admin interface
         */
        function displayExistingImages(images, savedImageIndex = null, savedZones = null) {
            const container = document.getElementById('existing-images-list');
            container.innerHTML = '';

            // If we just saved zones for an image, update that image's zones with the fresh data
            // to prevent race condition where backend data is stale
            if (savedImageIndex !== null && savedZones !== null) {
                const imageToUpdate = images.find(img => img.index === savedImageIndex);
                if (imageToUpdate) {
                    imageToUpdate.zones = savedZones;
                }
            }

            // Store images for target selection in zones
            adminState.lessonImages = images;

            if (images.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-full">No images yet. Upload your first image!</p>';
                return;
            }

            images.forEach((image, idx) => {
                const imageCard = document.createElement('div');
                imageCard.className = 'bg-gray-100 dark:bg-gray-700 rounded-lg p-4';
                imageCard.innerHTML = `
                    <img src="${image.url}" class="w-full h-32 object-cover rounded mb-2" alt="${image.description}">
                    <p class="text-sm font-semibold">Image ${idx + 1}</p>
                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-2" id="image-desc-${idx}">${image.description}</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="editImageDescription(${idx})" class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                            ‚úèÔ∏è Edit Info
                        </button>
                        <button onclick="editImageZones(this, ${idx})" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                            üìç Edit Zones
                        </button>
                        <button onclick="replaceImageFile(${idx})" class="px-2 py-1 bg-yellow-600 text-white text-xs rounded hover:bg-yellow-700">
                            üîÑ Replace
                        </button>
                        <button onclick="deleteImageFile(${idx})" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                `;
                container.appendChild(imageCard);
            });
        }

        /**
         * Handles image file (from upload or paste)
         */
        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                adminState.currentImageData = e.target.result;
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('image-preview-section').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        /**
         * Handles multiple image files and uploads them sequentially
         */
        async function handleMultipleImageFiles(files) {
            const fileArray = Array.from(files);

            if (fileArray.length === 0) return;

            // If only one file, use the standard single file flow
            if (fileArray.length === 1) {
                handleImageFile(fileArray[0]);
                return;
            }

            // Ask user for base description
            const confirmed = await showCustomModal({
                title: 'Upload Multiple Images',
                message: `You've selected ${fileArray.length} images. They will be uploaded with auto-generated descriptions (Image 1, Image 2, etc.). You can edit descriptions and add zones after upload. Continue?`,
                type: 'confirm'
            });

            if (!confirmed) return;

            // Get folder ID for this lesson first
            const folderResult = await new Promise((resolve) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler((err) => {
                        onScriptRunFailure(err);
                        resolve({ success: false });
                    })
                    .getLessonFolderId(adminState.currentLessonTitle);
            });

            if (!folderResult.success) {
                // Try to create the folder
                const createResult = await new Promise((resolve) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler((err) => {
                            onScriptRunFailure(err);
                            resolve({ success: false });
                        })
                        .createLessonFolder(adminState.currentLessonTitle);
                });

                if (!createResult.success) {
                    showCustomModal({ title: 'Error', message: 'Failed to get or create lesson folder.', type: 'confirm' });
                    return;
                }
                adminState.folderId = createResult.folderId;
            } else {
                adminState.folderId = folderResult.folderId;
            }

            // Hide the upload section and show a progress indicator
            const uploadSection = document.querySelector('#image-file-input').closest('.mb-6');
            const originalHTML = uploadSection.innerHTML;

            let successCount = 0;
            let failCount = 0;

            // Process each file sequentially
            for (let i = 0; i < fileArray.length; i++) {
                const file = fileArray[i];
                const currentIndex = adminState.currentImageIndex + i;
                const description = `Image ${currentIndex + 1}`;

                // Update progress
                uploadSection.innerHTML = `
                    <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center bg-gray-50 dark:bg-gray-700">
                        <div class="text-lg font-semibold mb-2">Uploading images...</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            Processing ${i + 1} of ${fileArray.length}: ${file.name}
                        </div>
                        <div class="mt-4 w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${((i + 1) / fileArray.length * 100)}%"></div>
                        </div>
                        <div class="mt-2 text-xs text-gray-500">
                            ${successCount} uploaded, ${failCount} failed
                        </div>
                    </div>
                `;

                try {
                    // Read file as base64
                    const base64Data = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const result = e.target.result;
                            resolve(result.split(',')[1]);
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });

                    const mimeType = file.type;
                    const fileName = `image_${currentIndex + 1}_${Date.now()}.${mimeType.split('/')[1]}`;

                    // Upload to Drive
                    const uploadResult = await new Promise((resolve) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler((err) => {
                                resolve({ success: false, message: err.message });
                            })
                            .uploadImageToDrive(base64Data, mimeType, fileName, adminState.folderId);
                    });

                    if (!uploadResult.success) {
                        failCount++;
                        continue;
                    }

                    // Save to spreadsheet
                    const updateResult = await new Promise((resolve) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler((err) => {
                                resolve({ success: false, message: err.message });
                            })
                            .updateLessonImage(
                                adminState.currentLessonTitle,
                                currentIndex,
                                description,
                                uploadResult.url,
                                '[]' // Empty zones initially
                            );
                    });

                    if (updateResult.success) {
                        successCount++;
                    } else {
                        failCount++;
                    }

                } catch (error) {
                    failCount++;
                }
            }

            // Restore original HTML
            uploadSection.innerHTML = originalHTML;

            // Re-attach event listeners (since we replaced the HTML)
            document.getElementById('upload-image-btn')?.addEventListener('click', () => document.getElementById('image-file-input').click());
            document.getElementById('image-file-input')?.addEventListener('change', (e) => {
                if (e.target.files.length > 0) handleMultipleImageFiles(e.target.files);
            });
            document.getElementById('paste-area')?.addEventListener('paste', (e) => {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        handleImageFile(items[i].getAsFile());
                        break;
                    }
                }
            });

            // Show result
            showCustomModal({
                title: 'Upload Complete',
                message: `Successfully uploaded ${successCount} of ${fileArray.length} images.${failCount > 0 ? ` ${failCount} failed.` : ''}`,
                type: 'confirm'
            });

            // Reload the images list
            loadExistingImages(adminState.currentLessonTitle);
        }

        /**
         * Clears the current image selection
         */
        function clearImage() {
            document.getElementById('image-preview-section').classList.add('hidden');
            document.getElementById('image-description-input').value = '';
            adminState.currentImageData = null;
        }

        /**
         * Saves image and proceeds to zone definition
         */
        function saveAndDefineZones() {
            const description = document.getElementById('image-description-input').value.trim();
            const saveBtn = document.getElementById('save-and-define-zones-btn');
            if (!description) {
                showCustomModal({ title: 'Input Required', message: 'Please enter an image description.', type: 'confirm'});
                return;
            }

            if (!adminState.currentImageData) {
                showCustomModal({ title: 'Error', message: 'No image selected.', type: 'confirm'});
                return;
            }

            showButtonLoader(saveBtn, 'Uploading...');

            // Upload image to Drive first
            const base64Data = adminState.currentImageData.split(',')[1];
            const mimeType = adminState.currentImageData.split(';')[0].split(':')[1];
            const fileName = `image_${adminState.currentImageIndex + 1}_${Date.now()}.${mimeType.split('/')[1]}`;

            // Get folder ID for this lesson
            google.script.run
                .withSuccessHandler((folderResult) => {
                    if (folderResult.success) {
                        adminState.folderId = folderResult.folderId;

                        // Upload the image
                        google.script.run
                            .withSuccessHandler((uploadResult) => {
                                hideButtonLoader(saveBtn);
                                if (uploadResult.success) {
                                    adminState.currentImage = {
                                        description: description,
                                        url: uploadResult.url,
                                        index: adminState.currentImageIndex
                                    };
                                    showZoneEditor();
                                } else {
                                     showCustomModal({ title: 'Error', message: 'Error uploading image: ' + uploadResult.message, type: 'confirm'});
                                }
                            })
                            .withFailureHandler((err) => {
                                hideButtonLoader(saveBtn);
                                onScriptRunFailure(err);
                            })
                            .uploadImageToDrive(base64Data, mimeType, fileName, adminState.folderId);
                    } else {
                        hideButtonLoader(saveBtn);
                        showCustomModal({ title: 'Error', message: 'Error getting folder: ' + folderResult.message, type: 'confirm'});
                    }
                })
                .withFailureHandler((err) => {
                    hideButtonLoader(saveBtn);
                    onScriptRunFailure(err);
                })
                .createLessonFolder(adminState.currentLessonTitle);
        }

        /**
         * Shows the zone editor
         */
        function showZoneEditor() {
            document.getElementById('admin-image-manager').classList.add('hidden');
            document.getElementById('admin-zone-editor').classList.remove('hidden');

            document.getElementById('admin-zone-editor-title').textContent = 'Define Click Zones';
            document.getElementById('admin-zone-editor-subtitle').textContent =
                `${adminState.currentLessonTitle} - Image ${adminState.currentImageIndex + 1}: ${adminState.currentImage.description}`;

            // Initialize canvas
            adminState.canvas = document.getElementById('admin-canvas');
            adminState.ctx = adminState.canvas.getContext('2d');

            // Setup canvas event listeners
            adminState.canvas.addEventListener('mousedown', handleAdminCanvasMouseDown);
            adminState.canvas.addEventListener('mousemove', handleAdminCanvasMouseMove);
            adminState.canvas.addEventListener('mouseup', handleAdminCanvasMouseUp);

            // Drawing mode buttons
            const rectBtn = document.getElementById('admin-draw-mode-rect');
            const polyBtn = document.getElementById('admin-draw-mode-poly');

            rectBtn.classList.add('draw-mode-btn', 'active');
            polyBtn.classList.add('draw-mode-btn');
            polyBtn.classList.remove('active');
            adminState.drawMode = 'rect'; // Default to rect

            rectBtn.addEventListener('click', () => {
                adminState.drawMode = 'rect';
                rectBtn.classList.add('active');
                polyBtn.classList.remove('active');
                adminState.currentPolygon = []; // Clear any partial polygon
                redrawAdminCanvas();
            });

            polyBtn.addEventListener('click', () => {
                adminState.drawMode = 'poly';
                polyBtn.classList.add('active');
                rectBtn.classList.remove('active');
            });

            // Load the image
            loadAdminImage(adminState.currentImageData);
            updateAdminZonesList();
        }

        /**
         * Loads an image into the admin canvas
         */
        function loadAdminImage(dataUrl) {
            const img = new Image();
            img.onload = () => {
                adminState.image = img;
                const maxWidth = 768;
                const aspectRatio = img.height / img.width;
                adminState.canvas.width = Math.min(img.width, maxWidth);
                adminState.canvas.height = adminState.canvas.width * aspectRatio;
                redrawAdminCanvas();
            };
            img.onerror = () => showCustomModal({ title: 'Error', message: 'Failed to load image.', type: 'confirm'});
            img.src = dataUrl;
        }

        /**
         * Redraws the admin canvas
         */
        function redrawAdminCanvas() {
            if (!adminState.image) return;

            const { ctx, canvas, image, zones, currentZone } = adminState;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

            zones.forEach((zone, index) => {
                drawAdminZone(zone, index, false);
            });

            if (currentZone) {
                drawAdminZone(currentZone, zones.length, true);
            }
        }

        /**
         * Draws a zone on the admin canvas
         */
        function drawAdminZone(zone, index, isTemporary) {
            const { ctx, canvas } = adminState;

            const x = (zone.x / 100) * canvas.width;
            const y = (zone.y / 100) * canvas.height;
            const width = (zone.width / 100) * canvas.width;
            const height = (zone.height / 100) * canvas.height;

            ctx.strokeStyle = isTemporary ? '#fbbf24' : '#3b82f6';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, height);

            ctx.fillStyle = isTemporary ? 'rgba(251, 191, 36, 0.2)' : 'rgba(59, 130, 246, 0.2)';
            ctx.fillRect(x, y, width, height);

            if (zone.label) {
                ctx.fillStyle = '#000';
                ctx.font = 'bold 14px Inter, sans-serif';
                ctx.fillText(zone.label, x + 5, y + 20);
            }
        }

        /**
         * Admin canvas mouse down handler
         */


        /**
         * Updates the admin zones list
         */
        function updateAdminZonesList() {
            const zonesList = document.getElementById('admin-zones-list');
            if (adminState.zones.length === 0) {
                zonesList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No zones defined yet.</p>';
                return;
            }
            zonesList.innerHTML = adminState.zones.map((zone, index) => {
                let targetInfo = '';
                if (zone.actionType === 'banner') {
                    const preview = zone.bannerText.length > 50 ? zone.bannerText.substring(0, 50) + '...' : zone.bannerText;
                    targetInfo = `<br>‚Üí Banner (${zone.bannerPosition}): "${preview}"`;
                } else if (zone.targetView !== undefined && zone.targetView !== null) {
                    const targetImage = adminState.lessonImages.find(img => img.index === zone.targetView);
                    targetInfo = targetImage
                        ? `<br>‚Üí Target: Image ${zone.targetView + 1} (${targetImage.description})`
                        : `<br>‚Üí Target: Image ${zone.targetView + 1}`;
                }

                let zoneDetails = '';
                if (zone.type === 'poly') {
                    zoneDetails = `Polygon with ${zone.points.length} points`;
                } else {
                    zoneDetails = `x: ${zone.x}%, y: ${zone.y}%<br>w: ${zone.width}%, h: ${zone.height}%`;
                }

                return `
                <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg flex justify-between items-start">
                    <div class="flex-1">
                        <div class="font-semibold text-sm">${zone.label || `Zone ${index + 1}`}</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                            ${zoneDetails}${targetInfo}
                        </div>
                    </div>
                    <div class="flex gap-1 ml-2">
                        <button onclick="editAdminZone(${index})" class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                            Edit
                        </button>
                        <button onclick="deleteAdminZone(${index})" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">
                            Delete
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function handleAdminCanvasMouseDown(e) {
            if (!adminState.image) return;

            if (adminState.drawMode === 'poly') {
                handlePolygonClick(e, adminState);
                return;
            }

            const rect = adminState.canvas.getBoundingClientRect();
            const scaleX = adminState.canvas.width / rect.width;
            const scaleY = adminState.canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            adminState.isDrawing = true;
            adminState.startX = x;
            adminState.startY = y;
            adminState.currentZone = null;
        }

        function handleAdminCanvasMouseMove(e) {
            if (adminState.drawMode === 'poly' || !adminState.isDrawing || !adminState.image) return;
            const rect = adminState.canvas.getBoundingClientRect();
            const scaleX = adminState.canvas.width / rect.width;
            const scaleY = adminState.canvas.height / rect.height;
            const currentX = (e.clientX - rect.left) * scaleX;
            const currentY = (e.clientY - rect.top) * scaleY;
            const x = Math.min(adminState.startX, currentX);
            const y = Math.min(adminState.startY, currentY);
            const width = Math.abs(currentX - adminState.startX);
            const height = Math.abs(currentY - adminState.startY);
            adminState.currentZone = {
                type: 'rect',
                x: (x / adminState.canvas.width) * 100,
                y: (y / adminState.canvas.height) * 100,
                width: (width / adminState.canvas.width) * 100,
                height: (height / adminState.canvas.height) * 100,
                label: ''
            };
            redrawAdminCanvas();
        }

        function handleAdminCanvasMouseUp(e) {
            if (adminState.drawMode === 'poly' || !adminState.isDrawing || !adminState.image) return;
            adminState.isDrawing = false;

            if (adminState.currentZone && adminState.currentZone.width > 1 && adminState.currentZone.height > 1) {
                // First ask for label
                showCustomModal({
                    title: 'Enter Zone Label',
                    message: 'Please provide an optional label for this zone.',
                    type: 'prompt',
                    placeholder: 'e.g., Nucleus'
                }).then(function(label) {
                    if (label !== null) {
                        if (label.trim() !== '') {
                            adminState.currentZone.label = label.trim();
                        }

                        // Then ask for action type
                        const imageOptions = [
                            { value: '', label: 'None (Sequential navigation)' },
                            { value: 'banner', label: 'üìù Display Text Banner' },
                            ...adminState.lessonImages.map(img => ({
                                value: img.index.toString(),
                                label: `Image ${img.index + 1}: ${img.description}`
                            }))
                        ];

                        showCustomModal({
                            title: 'Select Action',
                            message: 'What should happen when this zone is clicked?',
                            type: 'select',
                            options: imageOptions
                        }).then(function(targetView) {
                            if (targetView !== null) {
                                // Check if banner option was selected
                                if (targetView === 'banner') {
                                    // Ask for banner text
                                    showCustomModal({
                                        title: 'Banner Text',
                                        message: 'Enter the text to display in the banner:',
                                        type: 'prompt',
                                        placeholder: 'e.g., This is the mitochondria, the powerhouse of the cell!'
                                    }).then(function(bannerText) {
                                        if (bannerText !== null && bannerText.trim() !== '') {
                                            // Ask for banner position
                                            showCustomModal({
                                                title: 'Banner Position',
                                                message: 'Where should the banner appear?',
                                                type: 'select',
                                                options: [
                                                    { value: 'top', label: 'Top of screen' },
                                                    { value: 'bottom', label: 'Bottom of screen' }
                                                ]
                                            }).then(function(position) {
                                                if (position !== null) {
                                                    adminState.currentZone.actionType = 'banner';
                                                    adminState.currentZone.bannerText = bannerText.trim();
                                                    adminState.currentZone.bannerPosition = position;

                                                    adminState.zones.push(adminState.currentZone);
                                                    updateAdminZonesList();
                                                }
                                                adminState.currentZone = null;
                                                redrawAdminCanvas();
                                            });
                                        } else {
                                            adminState.currentZone = null;
                                            redrawAdminCanvas();
                                        }
                                    });
                                }
                                // Add targetView only if a specific image was selected
                                else if (targetView !== '') {
                                    adminState.currentZone.targetView = parseInt(targetView);

                                    adminState.zones.push(adminState.currentZone);
                                    updateAdminZonesList();

                                    adminState.currentZone = null;
                                    redrawAdminCanvas();
                                }
                                // Sequential navigation (no targetView)
                                else {
                                    adminState.zones.push(adminState.currentZone);
                                    updateAdminZonesList();

                                    adminState.currentZone = null;
                                    redrawAdminCanvas();
                                }
                            } else {
                                adminState.currentZone = null;
                                redrawAdminCanvas();
                            }
                        });
                    } else {
                        adminState.currentZone = null;
                        redrawAdminCanvas();
                    }
                });
            } else {
                adminState.currentZone = null;
                redrawAdminCanvas();
            }
        }

        function redrawAdminCanvas() {
            if (!adminState.image) return;
            const { ctx, canvas, image, zones, currentZone, currentPolygon } = adminState;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
            zones.forEach((zone, index) => drawAdminZone(zone, index, false));
            if (currentZone) drawAdminZone(currentZone, zones.length, true);

            if (currentPolygon.length > 0) {
                ctx.strokeStyle = '#fbbf24';
                ctx.lineWidth = 2;
                ctx.beginPath();
                currentPolygon.forEach((p, i) => {
                    const x = (p.x / 100) * canvas.width;
                    const y = (p.y / 100) * canvas.height;
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
            }
        }

        function drawAdminZone(zone, index, isTemporary) {
            const { ctx, canvas } = adminState;
            ctx.strokeStyle = isTemporary ? '#fbbf24' : '#3b82f6';
            ctx.lineWidth = 2;

            if (zone.type === 'poly') {
                ctx.beginPath();
                zone.points.forEach((p, i) => {
                    const x = (p.x / 100) * canvas.width;
                    const y = (p.y / 100) * canvas.height;
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.closePath();
                ctx.stroke();
                ctx.fillStyle = isTemporary ? 'rgba(251, 191, 36, 0.2)' : 'rgba(59, 130, 246, 0.2)';
                ctx.fill();
            } else { // rect
                const x = (zone.x / 100) * canvas.width;
                const y = (zone.y / 100) * canvas.height;
                const width = (zone.width / 100) * canvas.width;
                const height = (zone.height / 100) * canvas.height;
                ctx.strokeRect(x, y, width, height);
                ctx.fillStyle = isTemporary ? 'rgba(251, 191, 36, 0.2)' : 'rgba(59, 130, 246, 0.2)';
                ctx.fillRect(x, y, width, height);
            }

            if (zone.label) {
                ctx.fillStyle = '#000';
                ctx.font = 'bold 14px Inter, sans-serif';
                const x = (zone.type === 'poly' ? zone.points[0].x : zone.x) / 100 * canvas.width;
                const y = (zone.type === 'poly' ? zone.points[0].y : zone.y) / 100 * canvas.height;
                ctx.fillText(zone.label, x + 5, y + 20);
            }
        }

        /**
         * Edits a zone in the admin zones list
         */
        function editAdminZone(index) {
            const zone = adminState.zones[index];
            if (!zone) return;

            // Show modal to edit label
            showCustomModal({
                title: 'Edit Zone Label',
                message: 'Enter a new label for this zone (leave empty for default):',
                type: 'prompt',
                placeholder: zone.label || `Zone ${index + 1}`
            }).then(function(newLabel) {
                if (newLabel !== null) {
                    const trimmedLabel = newLabel.trim();

                    // Update the zone label
                    if (trimmedLabel !== '') {
                        adminState.zones[index].label = trimmedLabel;
                    } else {
                        // Remove label property to use default
                        delete adminState.zones[index].label;
                    }

                    // Then ask for action type
                    const imageOptions = [
                        { value: '', label: 'None (Sequential navigation)' },
                        { value: 'banner', label: 'üìù Display Text Banner' },
                        ...adminState.lessonImages.map(img => ({
                            value: img.index.toString(),
                            label: `Image ${img.index + 1}: ${img.description}`
                        }))
                    ];

                    // Set current value as default
                    let currentTarget = '';
                    if (zone.actionType === 'banner') {
                        currentTarget = 'banner';
                    } else if (zone.targetView !== undefined) {
                        currentTarget = zone.targetView.toString();
                    }

                    showCustomModal({
                        title: 'Select Action',
                        message: 'What should happen when this zone is clicked?',
                        type: 'select',
                        options: imageOptions,
                        defaultValue: currentTarget
                    }).then(function(targetView) {
                        if (targetView !== null) {
                            // Check if banner option was selected
                            if (targetView === 'banner') {
                                // Ask for banner text
                                const currentBannerText = zone.bannerText || '';
                                showCustomModal({
                                    title: 'Banner Text',
                                    message: 'Enter the text to display in the banner:',
                                    type: 'prompt',
                                    placeholder: 'e.g., This is the mitochondria, the powerhouse of the cell!',
                                    defaultValue: currentBannerText
                                }).then(function(bannerText) {
                                    if (bannerText !== null && bannerText.trim() !== '') {
                                        // Ask for banner position
                                        const currentPosition = zone.bannerPosition || 'bottom';
                                        showCustomModal({
                                            title: 'Banner Position',
                                            message: 'Where should the banner appear?',
                                            type: 'select',
                                            options: [
                                                { value: 'top', label: 'Top of screen' },
                                                { value: 'bottom', label: 'Bottom of screen' }
                                            ],
                                            defaultValue: currentPosition
                                        }).then(function(position) {
                                            if (position !== null) {
                                                // Remove old properties
                                                delete adminState.zones[index].targetView;
                                                // Set banner properties
                                                adminState.zones[index].actionType = 'banner';
                                                adminState.zones[index].bannerText = bannerText.trim();
                                                adminState.zones[index].bannerPosition = position;

                                                console.log('Admin zone edited:', adminState.zones[index]);
                                                updateAdminZonesList();
                                                redrawAdminCanvas();
                                            }
                                        });
                                    }
                                });
                            }
                            // Update targetView if a specific image was selected
                            else if (targetView !== '') {
                                // Remove old banner properties
                                delete adminState.zones[index].actionType;
                                delete adminState.zones[index].bannerText;
                                delete adminState.zones[index].bannerPosition;
                                // Set target view
                                adminState.zones[index].targetView = parseInt(targetView);

                                console.log('Admin zone edited:', adminState.zones[index]);
                                updateAdminZonesList();
                                redrawAdminCanvas();
                            }
                            // Sequential navigation (no targetView)
                            else {
                                // Remove all action properties
                                delete adminState.zones[index].targetView;
                                delete adminState.zones[index].actionType;
                                delete adminState.zones[index].bannerText;
                                delete adminState.zones[index].bannerPosition;

                                console.log('Admin zone edited:', adminState.zones[index]);
                                updateAdminZonesList();
                                redrawAdminCanvas();
                            }
                        }
                    });
                }
            });
        }
        // Expose to global scope for inline onclick handlers
        window.editAdminZone = editAdminZone;

        /**
         * Deletes a zone from admin zones list
         */
        function deleteAdminZone(index) {
            adminState.zones.splice(index, 1);
            updateAdminZonesList();
            redrawAdminCanvas();
        }
        window.deleteAdminZone = deleteAdminZone;

        document.getElementById('admin-clear-zones').addEventListener('click', () => {
            adminState.zones = [];
            adminState.currentPolygon = [];
            updateAdminZonesList();
            redrawAdminCanvas();
        });

        /**
         * Saves zones and returns to image manager
         */
        function saveAdminZones() {
            const zonesJson = JSON.stringify(adminState.zones);
            const saveBtn = document.getElementById('admin-save-zones-btn');
            showButtonLoader(saveBtn, 'Saving...');

            // Store the image index and zones we're saving
            const savedImageIndex = adminState.currentImage.index;
            const savedZones = zonesJson;

            google.script.run
                .withSuccessHandler((result) => {
                    hideButtonLoader(saveBtn);
                    if (result.success) {
                         showCustomModal({ title: 'Success', message: 'Zones saved successfully!', type: 'confirm'});
                        adminState.currentImageIndex++;
                        // Pass the saved image index and zones to prevent stale data
                        showImageManager(adminState.currentLessonTitle, savedImageIndex, savedZones);
                    } else {
                        showCustomModal({ title: 'Error', message: 'Error saving zones: ' + result.message, type: 'confirm'});
                    }
                })
                .withFailureHandler((err) => {
                    hideButtonLoader(saveBtn);
                    onScriptRunFailure(err);
                })
                .updateLessonImage(
                    adminState.currentLessonTitle,
                    adminState.currentImage.index,
                    adminState.currentImage.description,
                    adminState.currentImage.url,
                    zonesJson
                );
        }

        /**
         * Edits zones for an existing image
         */
        function editImageZones(button, imageIndex) {
            showButtonLoader(button, 'Loading...');
            // Load the image data and show zone editor
            google.script.run
                .withSuccessHandler((result) => {
                    if (result.success) {
                        // Store lesson images for target selection in zone dropdowns
                        adminState.lessonImages = result.data.images;

                        const image = result.data.images[imageIndex];
                        adminState.currentImage = image;
                        adminState.currentImageIndex = imageIndex;

                        // Parse existing zones
                        try {
                            adminState.zones = JSON.parse(image.zones || '[]');
                        } catch (e) {
                            adminState.zones = [];
                        }

                        // Fetch the image as base64 and show zone editor
                        const adminCanvasLoader = document.getElementById('admin-canvas-loader');
                        adminCanvasLoader.classList.remove('hidden');
                        google.script.run
                            .withSuccessHandler((base64DataUrl) => {
                                adminCanvasLoader.classList.add('hidden');
                                if (base64DataUrl) {
                                    adminState.currentImageData = base64DataUrl;
                                    showZoneEditor();
                                }
                            })
                            .withFailureHandler((err) => {
                                hideButtonLoader(button);
                                adminCanvasLoader.classList.add('hidden');
                                onScriptRunFailure(err);
                            })
                            .getImageAsBase64(image.url);
                    } else {
                        hideButtonLoader(button);
                    }
                })
                 .withFailureHandler((err) => {
                    hideButtonLoader(button);
                    onScriptRunFailure(err);
                 })
                .getLessonForEditing(adminState.currentLessonTitle);
        }

        /**
         * Edits an image's description
         */
        async function editImageDescription(imageIndex) {
            const image = adminState.lessonImages[imageIndex];
            const newDescription = await showCustomModal({
                title: 'Edit Image Description',
                message: 'Enter new description for this image:',
                type: 'prompt',
                placeholder: image.description
            });

            if (newDescription === null || newDescription.trim() === '') {
                return; // User cancelled or entered empty string
            }

            // Update in backend
            google.script.run
                .withSuccessHandler((result) => {
                    if (result.success) {
                        // Update the UI
                        const descElement = document.getElementById(`image-desc-${imageIndex}`);
                        if (descElement) {
                            descElement.textContent = newDescription;
                        }
                        // Update local state
                        adminState.lessonImages[imageIndex].description = newDescription;
                        showCustomModal({ title: 'Success', message: 'Image description updated successfully!', type: 'confirm'});
                    } else {
                        showCustomModal({ title: 'Error', message: 'Failed to update: ' + result.message, type: 'confirm'});
                    }
                })
                .withFailureHandler(onScriptRunFailure)
                .editImageMetadata(adminState.currentLessonTitle, imageIndex, newDescription);
        }

        /**
         * Replaces an existing image file
         */
        async function replaceImageFile(imageIndex) {
            const image = adminState.lessonImages[imageIndex];
            const confirmed = await showCustomModal({
                title: 'Replace Image',
                message: `Replace image ${imageIndex + 1}? This will delete the old file from Drive and upload a new one.`,
                type: 'confirm'
            });

            if (!confirmed) return;

            // Create file input
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Read file as base64
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const base64Data = event.target.result.split(',')[1];
                    const mimeType = event.target.result.split(';')[0].split(':')[1];
                    const fileName = `image_${imageIndex + 1}_${Date.now()}.${mimeType.split('/')[1]}`;
                    const description = image.description; // Keep existing description

                    // Show loading state
                    const container = document.getElementById('existing-images-list');
                    const originalHTML = container.innerHTML;
                    showSkeletonLoader(container, adminState.lessonImages.length, 'image');

                    google.script.run
                        .withSuccessHandler((result) => {
                            if (result.success) {
                                showCustomModal({ title: 'Success', message: 'Image replaced successfully!', type: 'confirm'});
                                // Reload images
                                loadExistingImages(adminState.currentLessonTitle);
                            } else {
                                container.innerHTML = originalHTML;
                                showCustomModal({ title: 'Error', message: 'Failed to replace: ' + result.message, type: 'confirm'});
                            }
                        })
                        .withFailureHandler((err) => {
                            container.innerHTML = originalHTML;
                            onScriptRunFailure(err);
                        })
                        .replaceImage(adminState.currentLessonTitle, imageIndex, base64Data, mimeType, fileName, description);
                };
                reader.readAsDataURL(file);
            };
            fileInput.click();
        }

        /**
         * Deletes an image file
         */
        async function deleteImageFile(imageIndex) {
            const confirmed = await showCustomModal({
                title: 'Delete Image',
                message: `Are you sure you want to delete image ${imageIndex + 1}? This will permanently remove it from both the spreadsheet and Google Drive. This action cannot be undone.`,
                type: 'confirm'
            });

            if (!confirmed) return;

            // Show loading state
            const container = document.getElementById('existing-images-list');
            const originalHTML = container.innerHTML;
            showSkeletonLoader(container, adminState.lessonImages.length, 'image');

            google.script.run
                .withSuccessHandler((result) => {
                    if (result.success) {
                        showCustomModal({ title: 'Success', message: 'Image deleted successfully!', type: 'confirm'});
                        // Reload images
                        loadExistingImages(adminState.currentLessonTitle);
                    } else {
                        container.innerHTML = originalHTML;
                        showCustomModal({ title: 'Error', message: 'Failed to delete: ' + result.message, type: 'confirm'});
                    }
                })
                .withFailureHandler((err) => {
                    container.innerHTML = originalHTML;
                    onScriptRunFailure(err);
                })
                .deleteImage(adminState.currentLessonTitle, imageIndex);
        }

        // Expose to global scope for inline onclick handlers
        window.editImageZones = editImageZones;
        window.editImageDescription = editImageDescription;
        window.replaceImageFile = replaceImageFile;
        window.deleteImageFile = deleteImageFile;



        // Event listeners for all buttons
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Zone banner close button
                document.getElementById('zone-banner-close')?.addEventListener('click', hideZoneBanner);

                // Modal buttons
                document.getElementById('modal-confirm-btn')?.addEventListener('click', handleModalConfirm);
                document.getElementById('modal-cancel-btn')?.addEventListener('click', handleModalCancel);

                // Main page buttons
                document.getElementById('lesson-setup-button')?.addEventListener('click', showAdminLogin);
                
                // Admin login
                document.getElementById('admin-login-btn')?.addEventListener('click', handleAdminLogin);
                document.getElementById('admin-login-cancel')?.addEventListener('click', hideAdminLogin);
                document.getElementById('admin-password')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleAdminLogin();
                });

                // Admin lesson list
                document.getElementById('admin-create-lesson-btn')?.addEventListener('click', showCreateLessonForm);
                document.getElementById('admin-back-to-main')?.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    showButtonLoader(btn, 'Loading...');
                    document.getElementById('admin-view').classList.add('hidden');
                    landingPage.style.display = 'block';
                    google.script.run
                        .withSuccessHandler((lessons) => {
                            hideButtonLoader(btn);
                            buildLandingPage(lessons);
                        })
                        .withFailureHandler((err) => {
                            hideButtonLoader(btn);
                            onScriptRunFailure(err);
                        })
                        .getLessons();
                });

                // Admin lesson form
                document.getElementById('admin-save-lesson-btn')?.addEventListener('click', saveLesson);
                document.getElementById('admin-cancel-lesson-btn')?.addEventListener('click', showAdminLessonList);

                // Admin image manager
                document.getElementById('upload-image-btn')?.addEventListener('click', () => document.getElementById('image-file-input').click());
                document.getElementById('image-file-input')?.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) handleMultipleImageFiles(e.target.files);
                });
                document.getElementById('paste-area')?.addEventListener('paste', (e) => {
                    const items = e.clipboardData.items;
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            handleImageFile(items[i].getAsFile());
                            break;
                        }
                    }
                });
                document.getElementById('admin-back-to-lesson-list')?.addEventListener('click', showAdminLessonList);
                document.getElementById('clear-image-btn')?.addEventListener('click', clearImage);
                document.getElementById('save-and-define-zones-btn')?.addEventListener('click', saveAndDefineZones);

                // Admin zone editor
                document.getElementById('admin-clear-zones')?.addEventListener('click', function() {
                    showCustomModal({ title: 'Confirm', message: 'Are you sure you want to clear all zones?', type: 'confirm'}).then(function(confirmed) {
                        if (confirmed) {
                            adminState.zones = [];
                            updateAdminZonesList();
                            redrawAdminCanvas();
                        }
                    });
                });
                document.getElementById('admin-save-zones-btn')?.addEventListener('click', saveAdminZones);
                document.getElementById('admin-back-to-images')?.addEventListener('click', () => {
                    showImageManager(adminState.currentLessonTitle);
                });

                // Coordinate Helper buttons
                document.getElementById('coord-back-to-lessons')?.addEventListener('click', () => {
                    document.getElementById('coord-image-selection').classList.add('hidden');
                    document.getElementById('coord-lesson-selection').classList.remove('hidden');
                });
                document.getElementById('coord-back-to-images')?.addEventListener('click', () => {
                    document.getElementById('coord-canvas-editor').classList.add('hidden');
                    document.getElementById('coord-image-selection').classList.remove('hidden');
                });
                document.getElementById('coord-back-to-lessons-from-canvas')?.addEventListener('click', () => {
                    document.getElementById('coord-canvas-editor').classList.add('hidden');
                    document.getElementById('coord-lesson-selection').classList.remove('hidden');
                });
                document.getElementById('copy-zones-array').addEventListener('click', (e) => {
                    const btn = e.target;
                    const originalText = btn.textContent;
                    document.getElementById('json-zones-array').select();
                    document.execCommand('copy');
                    btn.textContent = '‚úì Copied!';
                    setTimeout(() => { btn.textContent = originalText; }, 2000);
                });
                document.getElementById('copy-full-metadata').addEventListener('click', (e) => {
                     const btn = e.target;
                    const originalText = btn.textContent;
                    document.getElementById('json-full-metadata').select();
                    document.execCommand('copy');
                    btn.textContent = '‚úì Copied!';
                    setTimeout(() => { btn.textContent = originalText; }, 2000);
                });
                document.getElementById('clear-zones').addEventListener('click', function() {
                    showCustomModal({ title: 'Confirm Clear', message: 'Are you sure you want to clear all zones?', type: 'confirm'}).then(function(confirmed) {
                        if(confirmed) {
                            coordHelperState.zones = [];
                            redrawCanvas();
                            updateZonesList();
                            updateJsonOutput();
                        }
                    });
                });

            } catch (error) {
                console.error('Error setting up event listeners:', error);
            }
        });
    </script>
</body>
</html>

